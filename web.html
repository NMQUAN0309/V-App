<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<title>VTimes - Trang thông tin điện tử</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800&family=Noto+Serif:ital,wght@0,400;0,600;0,700&display=swap" rel="stylesheet">
<style>
/* ============================================================
   V-APP WEB — DESIGN SYSTEM
   ============================================================ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  /* Primary accent — vibrant royal blue */
  --red: #1C64D1;
  --red-dark: #1450A8;
  --red-light: #EBF3FF;
  --red-accent: #5B9DF5;
  /* Text — cool slate scale */
  --ink: #0D1B2E;
  --ink-secondary: #3A4F6A;
  --ink-tertiary: #6B82A0;
  --ink-faint: #9DB4CC;
  /* Surfaces */
  --surface: #F5F8FC;
  --surface-warm: #EBF0F7;
  --bg-card: #FFFFFF;
  /* Borders */
  --border: #C8D8EB;
  --border-light: #DDEAF6;
  --white: #FFFFFF;
  --font-body: 'Noto Sans', sans-serif;
  --font-headline: 'Noto Serif', 'Noto Sans', serif;
  --max-w: 1200px;
  --gutter: 24px;
  --radius: 4px;
  --shadow-sm: 0 1px 4px rgba(28,100,209,.07);
  --shadow-md: 0 3px 14px rgba(28,100,209,.10);
  --transition: .2s ease;
}

html { font-size: 16px; -webkit-font-smoothing: antialiased; scroll-behavior: smooth; }
body { font-family: var(--font-body); color: var(--ink); background: var(--white); line-height: 1.6; }
a { color: inherit; text-decoration: none; }
img { display: block; max-width: 100%; height: auto; }
button { font-family: inherit; cursor: pointer; border: none; background: none; }
ul, ol { list-style: none; }

/* scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* ============================================================
   UTILITY
   ============================================================ */
.container { max-width: var(--max-w); margin: 0 auto; padding: 0 var(--gutter); }
.page { display: none; }
.page.active { display: block; }
.sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }

/* ============================================================
   HEADER
   ============================================================ */
.site-header {
  position: sticky; top: 0; z-index: 100;
  background: var(--white);
  border-bottom: 3px solid var(--red);
}
.header-inner {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px var(--gutter);
  max-width: var(--max-w); margin: 0 auto;
}
.logo { display: flex; align-items: center; gap: 10px; }
.logo img { height: 40px; width: 40px; border-radius: 8px; }
.logo-text { font-family: var(--font-headline); font-size: 1.6rem; font-weight: 700; color: var(--red); letter-spacing: -.02em; }
.hamburger-btn {
  width: 40px; height: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
  border-radius: 8px; transition: background var(--transition);
}
.hamburger-btn:hover { background: var(--surface); }
.hamburger-btn span { display: block; width: 22px; height: 2px; background: var(--ink); border-radius: 1px; transition: var(--transition); }

/* ============================================================
   TICKER BAR
   ============================================================ */
.ticker-bar {
  background: linear-gradient(90deg, #1450A8 0%, #1C64D1 35%, #0891B2 70%, #0EA5E9 100%);
  color: #fff; overflow: hidden;
  font-size: .8rem; font-weight: 500; letter-spacing: .02em; height: 34px; line-height: 34px;
}
.ticker-track {
  display: flex; gap: 48px; white-space: nowrap;
  animation: tickerScroll 30s linear infinite;
}
.ticker-track span { display: inline-flex; align-items: center; gap: 8px; }
.ticker-track .dot {
  display: inline-block; width: 5px; height: 5px; border-radius: 50%;
  background: rgba(255,255,255,.55);
}
@keyframes tickerScroll {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}

/* ============================================================
   VIDEO FEED PAGE (trang mục Video — dark theme)
   ============================================================ */
#videoFeedPage {
  display: none; position: fixed;
  top: 130px; left: 0; right: 0; bottom: 0;
  background: var(--white); z-index: 100;
}
#videoFeedPage.active { display: flex; flex-direction: column; }
.vf-header {
  display: flex; align-items: center; gap: 16px;
  padding: 14px 32px; border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.vf-header h2 { color: var(--ink); font-size: 1.1rem; font-weight: 700; }
.vf-header-sub { color: var(--ink-tertiary); font-size: .82rem; }
.vf-feed {
  flex: 1; overflow-y: scroll;
  scroll-snap-type: y mandatory;
  scrollbar-width: thin; scrollbar-color: #ccc transparent;
}
.vf-feed::-webkit-scrollbar { width: 5px; }
.vf-feed::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
.vf-item {
  height: 100%; min-height: calc(100vh - 175px);
  scroll-snap-align: start; display: flex;
  flex-direction: column; justify-content: center;
  padding: 20px 80px; box-sizing: border-box;
  cursor: pointer; border-bottom: 1px solid var(--border);
}
.vf-item:hover .vf-play-icon { transform: translate(-50%,-50%) scale(1.1); background: var(--red); }
.vf-item:hover .vf-thumb { opacity: 1; }
.vf-thumb-wrap {
  position: relative; max-width: 820px; margin: 0 auto; width: 100%;
  aspect-ratio: 16/9; overflow: hidden; border-radius: 12px; background: #111;
}
.vf-thumb { width: 100%; height: 100%; object-fit: cover; display: block; opacity: .82; transition: opacity .3s; }
.vf-play-icon {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
  width: 70px; height: 70px; background: rgba(0,0,0,.72); border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-size: 28px; padding-left: 5px;
  transition: transform .2s, background .2s; pointer-events: none;
}
.vf-duration-badge {
  position: absolute; bottom: 10px; right: 12px;
  background: rgba(0,0,0,.82); color: #fff;
  font-size: .75rem; padding: 2px 8px; border-radius: 4px; font-weight: 600;
}
.vf-info { max-width: 820px; margin: 14px auto 0; }
.vf-title { color: var(--ink); font-size: 1.1rem; font-weight: 600; line-height: 1.4; margin-bottom: 4px; }
.vf-meta { color: var(--ink-tertiary); font-size: .82rem; }

/* Video Lightbox */
.video-lightbox {
  position: fixed; inset: 0; background: rgba(0,0,0,.94);
  z-index: 3000; display: none; flex-direction: column;
  align-items: center; justify-content: center; gap: 12px;
}
.video-lightbox.open { display: flex; }
.vlb-close {
  position: absolute; top: 20px; right: 24px;
  color: #ccc; font-size: 2rem; cursor: pointer; line-height: 1;
  transition: color .2s; background: none; border: none; z-index: 10;
}
.vlb-close:hover { color: #fff; }
/* Carousel */
.vlb-carousel {
  display: flex; overflow-x: scroll; scroll-snap-type: x mandatory;
  width: 100%; max-width: 860px;
  scrollbar-width: none; -ms-overflow-style: none;
}
.vlb-carousel::-webkit-scrollbar { display: none; }
.vlb-slide {
  flex: 0 0 100%; scroll-snap-align: start;
  display: flex; flex-direction: column; align-items: flex-start;
}
.vlb-thumb-wrap {
  position: relative; aspect-ratio: 16/9; width: 100%;
  overflow: hidden; border-radius: 14px; background: #111;
}
.vlb-thumb { width: 100%; height: 100%; object-fit: cover; display: block; }
.vlb-play {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
  width: 90px; height: 90px; background: rgba(229,57,53,.88); border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-size: 38px; padding-left: 7px; pointer-events: none;
}
.vlb-title { color: #f0f0f0; font-size: 1.1rem; font-weight: 600; margin-top: 18px; line-height: 1.4; }
.vlb-note { color: #888; font-size: .8rem; }

/* ============================================================
   NAVIGATION
   ============================================================ */
.main-nav {
  background: var(--white); border-bottom: 1px solid var(--border);
  position: sticky; top: 59px; z-index: 90;
}
.nav-inner {
  display: flex; align-items: stretch; gap: 0;
  max-width: var(--max-w); margin: 0 auto; padding: 0 var(--gutter);
}
.nav-fixed-group {
  display: flex; align-items: center; flex-shrink: 0;
  border-right: 2px solid var(--border);
}
.nav-cats-scroll {
  flex: 1; min-width: 0; overflow-x: auto;
  -ms-overflow-style: none; scrollbar-width: none;
  display: flex; align-items: center;
  cursor: grab; user-select: none;
}
.nav-cats-scroll::-webkit-scrollbar { display: none; }
.nav-cats-scroll.is-dragging { cursor: grabbing; }
.nav-cats-inner {
  display: flex; align-items: center; flex-shrink: 0;
}

.nav-special-btn {
  padding: 10px 16px; font-size: .85rem; font-weight: 600;
  white-space: nowrap; border-right: 1px solid var(--border);
  color: var(--red); transition: background var(--transition);
  position: relative; display: flex; align-items: center;
}
.nav-special-btn:hover { background: var(--red-light); }

/* Subcategory bar below nav */
.web-cat-subs-bar {
  display: none; background: var(--surface);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 100px; z-index: 85;
}
.web-cat-subs-inner {
  display: flex; align-items: center;
  max-width: var(--max-w); margin: 0 auto; padding: 0 var(--gutter);
  overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; gap: 0;
}
.web-cat-subs-inner::-webkit-scrollbar { display: none; }
.web-cat-sub-link {
  padding: 7px 14px; font-size: .82rem; font-weight: 500;
  white-space: nowrap; color: var(--ink-secondary);
  border-bottom: 2px solid transparent; transition: all .2s;
}
.web-cat-sub-link:hover, .web-cat-sub-link.active {
  color: var(--red); border-bottom-color: var(--red);
}

.nav-local-wrapper { position: relative; }
.local-dropdown {
  display: none; position: absolute; top: 100%; left: 0;
  background: var(--white); border: 1px solid var(--border); border-radius: var(--radius);
  box-shadow: var(--shadow-md); z-index: 50; min-width: 160px;
}
.local-dropdown.show { display: block; }
.local-dropdown a {
  display: block; padding: 8px 16px; font-size: .85rem;
  transition: background var(--transition);
}
.local-dropdown a:hover { background: var(--surface); color: var(--red); }

.nav-cat-link {
  padding: 10px 14px; font-size: .85rem; font-weight: 500;
  white-space: nowrap; transition: color var(--transition); position: relative;
}
.nav-cat-link:hover, .nav-cat-link.active { color: var(--red); }
.nav-cat-link.active::after {
  content: ''; position: absolute; bottom: 0; left: 14px; right: 14px;
  height: 2px; background: var(--red);
}

/* ============================================================
   HAMBURGER MENU OVERLAY
   ============================================================ */
.menu-overlay {
  position: fixed; inset: 0; z-index: 200;
  pointer-events: none; opacity: 0; transition: opacity .3s;
}
.menu-overlay.open { pointer-events: all; opacity: 1; }
.menu-backdrop {
  position: absolute; inset: 0; background: rgba(0,0,0,.4);
}
.menu-panel {
  position: absolute; top: 0; left: 0; bottom: 0; width: 360px;
  background: var(--white); transform: translateX(-100%);
  transition: transform .35s cubic-bezier(.22,1,.36,1);
  overflow-y: auto; box-shadow: 4px 0 24px rgba(0,0,0,.15);
}
.menu-overlay.open .menu-panel { transform: translateX(0); }

.menu-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 24px; border-bottom: 2px solid var(--red);
}
.menu-header .logo-text { font-size: 1.3rem; }
.menu-close {
  width: 36px; height: 36px; font-size: 1.4rem; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  transition: background var(--transition);
}
.menu-close:hover { background: var(--surface); }

.menu-list { padding: 8px 0; }
.menu-cat {
  border-bottom: 1px solid var(--border-light);
}
.menu-cat-main {
  display: block; padding: 12px 24px;
  font-weight: 700; font-size: .95rem; color: var(--ink);
  transition: color var(--transition);
}
.menu-cat-main:hover { color: var(--red); }
.menu-subs {
  display: flex; flex-wrap: wrap; gap: 4px 12px;
  padding: 0 24px 12px 36px;
}
.menu-sub-link {
  font-size: .82rem; color: var(--ink-secondary);
  transition: color var(--transition);
}
.menu-sub-link:hover { color: var(--red); }

/* ============================================================
   ARTICLE CARDS
   ============================================================ */
.article-card { cursor: pointer; transition: opacity var(--transition); }
.article-card:hover { opacity: .85; }
.article-card .ava {
  width: 100%; aspect-ratio: 16/9; object-fit: cover;
  border-radius: var(--radius); background: var(--surface);
}
.article-card .ava-sm {
  width: 100%; aspect-ratio: 4/3; object-fit: cover;
  border-radius: var(--radius); background: var(--surface);
}
.article-card .title {
  font-family: var(--font-headline); font-weight: 700;
  line-height: 1.35; margin-top: 8px; color: var(--ink);
  display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
}
.article-card .title:hover { color: var(--red); }
.article-card .sapo {
  font-size: .87rem; color: var(--ink-secondary); margin-top: 4px; line-height: 1.5;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.article-card .meta-time {
  font-size: .75rem; color: var(--ink-faint); margin-top: 4px;
}

.article-row {
  display: flex; gap: 16px; padding: 14px 0;
  border-bottom: 1px solid var(--border-light);
  cursor: pointer; transition: background var(--transition);
}
.article-row:hover { background: var(--surface-warm); }
.article-row .ava-thumb {
  width: 120px; min-width: 120px; height: 80px; object-fit: cover;
  border-radius: var(--radius); background: var(--surface);
}
.article-row .info { flex: 1; }
.article-row .title {
  font-weight: 600; font-size: .92rem; line-height: 1.35;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.article-row .title:hover { color: var(--red); }
.article-row .sapo {
  font-size: .8rem; color: var(--ink-secondary); margin-top: 3px; line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}

.title-only-card { padding: 8px 0; border-bottom: 1px solid var(--border-light); cursor: pointer; }
.title-only-card .title {
  font-weight: 600; font-size: .9rem; line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.title-only-card .title:hover { color: var(--red); }
.title-only-card .sapo {
  font-size: .8rem; color: var(--ink-tertiary); margin-top: 2px; line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}

/* ============================================================
   SECTION HEADERS
   ============================================================ */
.section-head {
  display: flex; align-items: baseline; gap: 16px; flex-wrap: wrap;
  padding-bottom: 10px; margin-bottom: 16px;
  border-bottom: 2px solid var(--red);
}
.section-head .sec-title {
  font-family: var(--font-headline); font-weight: 700; font-size: 1.15rem;
  color: var(--red); cursor: pointer;
}
.section-head .sec-title:hover { color: var(--red-dark); }
.section-head .sec-subs { display: flex; gap: 12px; flex-wrap: wrap; }
.section-head .sec-sub {
  font-size: .82rem; color: var(--ink-secondary);
  transition: color var(--transition);
}
.section-head .sec-sub:hover { color: var(--red); }

/* ============================================================
   HOMEPAGE — TOP CLUSTER
   ============================================================ */
.top-cluster { margin: var(--gutter) 0; }
.top-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: var(--gutter);
}
.top-featured-row {
  grid-column: 1 / -1;
  display: grid; grid-template-columns: 8fr 2.5fr; gap: var(--gutter); align-items: start;
}
.top-featured .h-ava { width: 62% !important; }
.top-featured .title { font-size: 1.6rem; }
.top-featured .sapo { font-size: .95rem; -webkit-line-clamp: 3; }
.top-featured-secondary.card-h { flex-direction: column; }
.top-featured-secondary .h-ava { width: 100% !important; aspect-ratio: 16/9; }
.top-featured-secondary .title { font-size: 1rem; }
.top-featured-secondary .sapo { font-size: .82rem; -webkit-line-clamp: 2; }
.cat-badge {
  display: inline-block; font-size: .72rem; font-weight: 700; letter-spacing: .03em;
  color: #fff; background: var(--red); border-radius: 3px;
  padding: 2px 7px; margin-bottom: 6px; text-decoration: none;
  cursor: pointer;
}
.cat-badge:hover { background: var(--red-dark, #c62828); }

/* ============================================================
   GÓC CHUYÊN GIA PAGE
   ============================================================ */
.gcg-wrap { display: grid; grid-template-columns: 1fr 280px; gap: 36px; margin-top: 8px; }
.gcg-list { display: flex; flex-direction: column; }
.gcg-article {
  display: flex; gap: 14px; align-items: flex-start;
  padding: 16px 0; border-bottom: 1px solid var(--border-light); cursor: pointer;
}
.gcg-article:first-child { padding-top: 0; }
.gcg-article:last-child { border-bottom: none; }
.gcg-body { flex: 1; min-width: 0; }
.gcg-title {
  font-family: var(--font-headline); font-weight: 700; font-size: 1.02rem;
  color: var(--ink); line-height: 1.4; margin-bottom: 5px;
  display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
}
.gcg-title:hover { color: var(--red); }
.gcg-sapo {
  font-size: .85rem; color: var(--ink-secondary); line-height: 1.5; margin-bottom: 7px;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.gcg-avatar-wrap {
  flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 5px; width: 70px;
}
.gcg-avatar {
  width: 58px; height: 58px;
  border-radius: 50%; object-fit: cover; object-position: top center;
  border: 2px solid var(--border-light); background: var(--surface); cursor: pointer;
}
.gcg-author {
  font-size: .72rem; font-weight: 700; color: var(--red);
  text-align: center; line-height: 1.3; word-break: break-word;
}
/* GCG Sidebar */
.gcg-sidebar-head {
  font-family: var(--font-headline); font-weight: 700; font-size: .9rem;
  color: var(--ink); border-bottom: 2px solid var(--red); padding-bottom: 7px; margin-bottom: 12px;
}
.gcg-sidebar-item {
  display: flex; gap: 10px; padding: 10px 0;
  border-bottom: 1px solid var(--border-light); cursor: pointer;
}
.gcg-sidebar-item:last-child { border-bottom: none; }
.gcg-sidebar-ava {
  flex-shrink: 0; width: 72px; height: 50px;
  object-fit: cover; border-radius: var(--radius); background: var(--surface);
}
.gcg-sidebar-body { flex: 1; min-width: 0; }
.gcg-sidebar-title {
  font-size: .84rem; font-weight: 600; color: var(--ink); line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
  margin-bottom: 4px;
}
.gcg-sidebar-title:hover { color: var(--red); }
.gcg-sidebar-author { font-size: .74rem; font-weight: 700; color: var(--red); }

.top-small-grid {
  grid-column: 1 / -1;
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: var(--gutter);
}
.top-small-grid .title { font-size: 1rem; }

/* ============================================================
   HOMEPAGE — MAIN 2-COL
   ============================================================ */
.home-main {
  display: grid; grid-template-columns: 1fr 2fr;
  gap: 32px; margin-bottom: 48px;
}
/* min-width:0 prevents grid columns blowing up due to wide children (e.g. match ticker) */
.home-left, .home-right { min-width: 0; }

.home-left { border-right: 1px solid var(--border-light); padding-right: 32px; }
.home-left .article-row:first-child { padding-top: 0; }

/* right featured clusters */
.featured-cluster { margin-bottom: 32px; }
.featured-cluster:last-child { margin-bottom: 0; }
.fc-row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px; }
.fc-row3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }

/* featured interstitial boxes (between clusters in right col) */
.featured-interstitial { margin-bottom: 28px; }
.match-schedule-box {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; padding: 10px 14px; overflow: hidden;
}
.match-box-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 8px;
}
.match-box-title {
  font-size: .8rem; font-weight: 700; color: var(--ink); letter-spacing: .03em;
  text-transform: uppercase;
}
.match-box-more {
  font-size: .75rem; color: var(--red); text-decoration: none;
}
.match-box-more:hover { text-decoration: underline; }
.match-ticker-wrap { overflow: hidden; position: relative; height: 24px; }
.match-ticker-inner {
  display: flex; align-items: center; gap: 0;
  white-space: nowrap;
  animation: matchTicker 30s linear infinite;
}
.match-ticker-wrap:hover .match-ticker-inner { animation-play-state: paused; }
@keyframes matchTicker {
  0%   { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}
.match-item {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: .75rem; color: var(--ink-secondary);
  padding: 0 14px;
  border-right: 1px solid var(--border);
}
.match-item:last-child { border-right: none; }
.match-time { color: var(--red); font-weight: 600; font-size: .7rem; }
.match-vs { color: var(--ink-tertiary); font-size: .7rem; }

/* quote box */
.quote-box {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; overflow: hidden; padding: 0;
}
.quote-photo-wrap { width: 100%; overflow: hidden; line-height: 0; }
.quote-photo { width: 100%; height: 130px; object-fit: cover; object-position: top center; display: block; filter: grayscale(15%); }
.quote-body { padding: 12px 14px 14px; }
.quote-text {
  font-size: .81rem; line-height: 1.55; color: var(--ink);
  font-style: italic; margin-bottom: 8px;
}
.quote-text::before { content: '"'; }
.quote-text::after  { content: '"'; }
.quote-author { font-size: .74rem; font-weight: 600; color: var(--ink-secondary); text-align: right; }

/* coming soon page */
.coming-soon-wrap {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  min-height: 380px; padding: 60px 24px;
  text-align: center;
}
.coming-soon-icon { font-size: 3rem; margin-bottom: 16px; }
.coming-soon-title {
  font-size: 1.4rem; font-weight: 700; color: var(--ink); margin-bottom: 8px;
}
.coming-soon-sub {
  font-size: .9rem; color: var(--ink-secondary); max-width: 340px; line-height: 1.6;
}

/* ============================================================
   HOMEPAGE — REMAINING CATEGORIES
   ============================================================ */
.remaining-cats {
  display: grid; grid-template-columns: 1fr;
  gap: 32px; margin-bottom: 48px;
}
.remaining-cat .rem-featured { margin-bottom: 8px; }
.remaining-cat .rem-featured .title { font-size: 1rem; }
/* Remaining cat with side box */
.remaining-cat.rem-with-box {
  display: grid; grid-template-columns: 1fr 300px; gap: 24px; align-items: start;
}
.rem-articles-col { min-width: 0; }
.rem-box-col { min-width: 0; }
/* Weather box */
.weather-cities { display: flex; flex-direction: column; gap: 0; }
.weather-city {
  display: flex; align-items: center; gap: 8px; padding: 7px 0;
  border-bottom: 1px solid var(--border-light); font-size: .84rem;
}
.weather-city:last-child { border-bottom: none; }
.w-city-name { font-weight: 600; min-width: 68px; color: var(--ink); }
.w-icon { font-size: 1.15rem; }
.w-temp { font-weight: 700; color: var(--red); min-width: 44px; }
.w-desc { color: var(--ink-tertiary); font-size: .78rem; }
/* War map compact (home page side box) */
.conflict-list-compact { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
.conflict-card {
  padding: 9px 12px; border-radius: 6px; background: var(--white);
  border: 1px solid var(--border); cursor: pointer; transition: all .2s;
}
.conflict-card:hover { border-color: var(--red); box-shadow: var(--shadow-sm); }
.conflict-flag-row { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; }
.cf-tag {
  padding: 2px 7px; border-radius: 4px; font-size: .72rem; font-weight: 600;
  color: #fff; flex: 1; text-align: center; white-space: nowrap;
}
.cf-vs { font-size: .85rem; flex-shrink: 0; }
.conflict-sub { font-size: .72rem; color: var(--ink-tertiary); }
.war-map-more-link {
  display: block; text-align: right; font-size: .79rem; color: var(--red);
  font-weight: 600; margin-top: 2px;
}
.war-map-more-link:hover { text-decoration: underline; }

/* ============================================================
   VN NEWS MAP — WEB
   ============================================================ */
.vn-map-web-wrap {
  position: relative; line-height: 0; background: #b8d4e8;
  border-radius: 6px; overflow: hidden; margin-bottom: 10px;
  max-height: 300px;
}
.vn-map-web-wrap svg { width: 100%; display: block; }
.vn-map-legend {
  display: flex; align-items: center; gap: 7px;
  font-size: .75rem; color: var(--ink-secondary); margin-bottom: 4px;
}
.vn-legend-dot {
  display: inline-block; width: 9px; height: 9px; border-radius: 50%;
  background: #E53935; flex-shrink: 0;
  box-shadow: 0 0 0 3px rgba(229,57,53,.2);
}
@keyframes vnPulse {
  0%   { transform: scale(1); opacity: 0.8; }
  80%  { transform: scale(3); opacity: 0; }
  100% { transform: scale(3); opacity: 0; }
}
.vn-pulse-ring {
  fill: #E53935; pointer-events: none;
  transform-box: fill-box; transform-origin: center;
  animation: vnPulse 2s ease-out infinite;
}
.vn-dot-center { fill: #E53935; stroke: #fff; stroke-width: 1; }
.vn-map-event-dot { cursor: pointer; }
/* VN Event Modal (Web — centered) */
.vn-event-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.45);
  z-index: 800; display: none;
  align-items: center; justify-content: center;
}
.vn-event-overlay.open { display: flex; }
.vn-event-panel {
  background: var(--white); border-radius: 12px;
  width: 100%; max-width: 560px; max-height: 80vh;
  overflow-y: auto; position: relative;
  box-shadow: 0 20px 60px rgba(0,0,0,.25);
  animation: vnModalIn .22s ease;
}
@keyframes vnModalIn {
  from { opacity: 0; transform: scale(.96); }
  to   { opacity: 1; transform: scale(1); }
}
.vn-ep-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px; border-bottom: 1px solid var(--border);
  position: sticky; top: 0; background: var(--white); z-index: 2;
  border-radius: 12px 12px 0 0;
}
.vn-ep-title { font-weight: 700; font-size: 1rem; color: var(--ink); flex: 1; }
.vn-ep-close {
  width: 32px; height: 32px; border-radius: 50%; background: var(--surface);
  display: flex; align-items: center; justify-content: center;
  font-size: .9rem; color: var(--ink-secondary); flex-shrink: 0;
}
.vn-ep-close:hover { background: var(--surface-warm); }
.vn-ep-location {
  display: flex; align-items: center; gap: 6px;
  padding: 8px 20px; background: #FEF2F2; border-bottom: 1px solid #FECACA;
  font-size: .8rem; font-weight: 600; color: #DC2626;
}
.vn-ep-top-article {
  display: flex; gap: 14px; padding: 14px 20px;
  border-bottom: 1px solid var(--border-light); cursor: pointer;
}
.vn-ep-top-article:hover { background: var(--surface); }
.vn-ep-top-img {
  width: 90px; height: 68px; border-radius: 6px; object-fit: cover; flex-shrink: 0;
}
.vn-ep-top-body { flex: 1; min-width: 0; }
.vn-ep-top-badge {
  display: inline-block; font-size: .62rem; font-weight: 700;
  background: #E53935; color: #fff; padding: 1px 7px; border-radius: 3px; margin-bottom: 6px;
}
.vn-ep-top-time { font-size: .7rem; color: var(--ink-faint); margin-bottom: 3px; }
.vn-ep-top-title { font-size: .9rem; font-weight: 700; color: var(--ink); line-height: 1.4; }
.vn-ep-list-item {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 11px 20px; border-bottom: 1px solid var(--border-light); cursor: pointer;
}
.vn-ep-list-item:hover { background: var(--surface); }
.vn-ep-list-time { font-size: .7rem; color: var(--ink-faint); min-width: 66px; flex-shrink: 0; margin-top: 2px; }
.vn-ep-list-title { font-size: .84rem; color: var(--ink); line-height: 1.4; }
.vn-ep-see-more {
  display: block; text-align: center; font-size: .82rem; font-weight: 600;
  color: var(--red); padding: 14px 20px;
}
.vn-ep-see-more:hover { text-decoration: underline; }

/* Mini war map (home sidebar + mobile) */
.wm-mini-wrap {
  position: relative; line-height: 0; background: #b8d4e8;
  border-radius: 6px; overflow: hidden; margin-bottom: 10px; cursor: pointer;
}
.wm-mini-wrap .wm-svg { width: 100%; display: block; }
.wm-mini-wrap .wm-loading { min-height: 100px; font-size: .78rem; }
.wm-mini-legend { display: flex; flex-direction: column; gap: 5px; margin-bottom: 8px; }
.wm-mini-conflict { display: flex; align-items: center; gap: 7px; font-size: .74rem; color: var(--ink-secondary); }
.wm-mini-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; display: inline-block; }
/* Full war map widget (category page) */
.war-map-full {
  border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 24px;
}
.wm-full-header {
  padding: 13px 20px; background: #1a237e;
  display: flex; justify-content: space-between; align-items: center;
}
.wm-full-header h3 { color: #fff; font-size: .95rem; margin: 0; font-weight: 700; }
.wm-full-subtitle { font-size: .74rem; color: rgba(255,255,255,.65); }
.wm-svg-wrap { position: relative; line-height: 0; background: #b8d4e8; min-height: 180px; }
.wm-svg { width: 100%; display: block; }
.wm-country { transition: filter .18s; cursor: pointer; }
.wm-country:hover { filter: brightness(1.12) drop-shadow(0 0 5px rgba(0,0,0,.25)); }
.wm-loading {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  padding: 40px 20px; min-height: 180px; color: #6b8fa8; font-size: .84rem;
}
.wm-loading-spinner {
  width: 20px; height: 20px; border-radius: 50%;
  border: 2px solid rgba(107,143,168,.3);
  border-top-color: #6b8fa8;
  animation: wmSpin .8s linear infinite;
}
@keyframes wmSpin { to { transform: rotate(360deg); } }
.wm-load-error {
  padding: 32px 20px; color: #999; font-size: .82rem; text-align: center; min-height: 120px;
  display: flex; align-items: center; justify-content: center;
}
.wm-tooltip {
  position: absolute; background: rgba(20,20,40,.88); color: #fff;
  padding: 5px 11px; border-radius: 5px; font-size: .79rem; white-space: nowrap;
  pointer-events: none; display: none; z-index: 10;
}
.wm-legend {
  display: flex; border-top: 1px solid var(--border); background: var(--white);
}
.wm-legend-item {
  flex: 1; padding: 11px 16px; display: flex; align-items: center; gap: 10px;
  border-right: 1px solid var(--border); cursor: pointer; transition: background .2s;
}
.wm-legend-item:last-child { border-right: none; }
.wm-legend-item:hover { background: var(--surface); }
.wm-legend-color { width: 13px; height: 13px; border-radius: 3px; flex-shrink: 0; }
.wm-legend-texts { flex: 1; }
.wm-conflict-name { font-size: .83rem; font-weight: 600; color: var(--ink); }
.wm-conflict-date { font-size: .73rem; color: var(--ink-tertiary); margin-top: 1px; }
.wm-legend-arr { color: var(--ink-tertiary); font-size: 1.1rem; }
.wm-articles-panel {
  border-top: 1px solid var(--border); padding: 14px 20px; background: var(--surface);
}
.wm-articles-panel h4 { font-size: .88rem; margin-bottom: 10px; color: var(--ink); font-weight: 700; }
.wm-art-item { padding: 7px 0; border-bottom: 1px solid var(--border-light); cursor: pointer; }
.wm-art-item:last-child { border-bottom: none; }
.wm-art-item:hover .wm-art-title { color: var(--red); }
.wm-art-title { font-size: .84rem; font-weight: 600; line-height: 1.4; color: var(--ink); }
.wm-art-time { font-size: .73rem; color: var(--ink-tertiary); margin-top: 2px; }

/* ============================================================
   CATEGORY PAGE
   ============================================================ */
.cat-special-box {
  background: var(--surface-warm); border: 1px solid var(--border);
  border-radius: 8px; padding: 20px 24px; margin-bottom: 24px;
}
.cat-special-box h3 {
  font-size: .95rem; font-weight: 600; margin-bottom: 12px; color: var(--ink);
}
.cat-special-box .search-row {
  display: flex; gap: 10px; flex-wrap: wrap;
}
.cat-special-box input, .cat-special-box select {
  padding: 8px 14px; border: 1px solid var(--border); border-radius: var(--radius);
  font-size: .87rem; font-family: var(--font-body);
  background: var(--white); flex: 1; min-width: 140px;
}
.cat-special-box input:focus, .cat-special-box select:focus {
  outline: none; border-color: var(--red);
}
.cat-special-box .search-btn {
  padding: 8px 20px; background: var(--red); color: var(--white);
  border-radius: var(--radius); font-weight: 600; font-size: .87rem;
  transition: background var(--transition);
}
.cat-special-box .search-btn:hover { background: var(--red-dark); }

.cat-top-cluster {
  display: grid; grid-template-columns: 1fr; gap: var(--gutter); margin-bottom: 32px;
}
.cat-top-with-map { display: flex; gap: 28px; align-items: flex-start; }
.cat-top-articles-col { flex: 1; min-width: 0; display: grid; grid-template-columns: 1fr; gap: var(--gutter); }
.cat-top-map-col { width: 280px; flex-shrink: 0; }
.cat-top-map-col .cat-special-box { margin: 0; }
.cat-top-featured .title { font-size: 1.5rem; }
.cat-top-small {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--gutter);
}
.cat-top-small .title { font-size: .95rem; }

.cat-main-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 32px;
}
.cat-left { border-right: 1px solid var(--border-light); padding-right: 32px; }
.cat-right .sub-cluster { margin-bottom: 24px; }
.sub-cluster-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

.cat-stream { margin-bottom: 48px; }
.cat-stream .section-head { border-bottom-color: var(--border); }

/* ============================================================
   ARTICLE DETAIL PAGE
   ============================================================ */
.article-detail { max-width: 780px; margin: 0 auto; padding: 0 var(--gutter); padding-bottom: 80px; }
.article-breadcrumb {
  display: flex; gap: 8px; font-size: .82rem; color: var(--ink-tertiary);
  margin-top: 20px; margin-bottom: 8px;
}
.article-breadcrumb a { color: var(--red); }
.article-breadcrumb a:hover { text-decoration: underline; }
.article-breadcrumb .sep { color: var(--ink-faint); }

.article-meta {
  display: flex; align-items: center; gap: 16px;
  font-size: .82rem; color: var(--ink-tertiary); margin-bottom: 16px;
}
.audio-btn {
  display: inline-flex; align-items: center; gap: 4px;
  color: var(--red); font-weight: 600; font-size: .82rem;
  padding: 4px 10px; border: 1px solid var(--red); border-radius: 20px;
  transition: background var(--transition);
}
.audio-btn:hover { background: var(--red-light); }
.summary-btn {
  display: inline-flex; align-items: center; gap: 4px;
  color: var(--red); font-weight: 600; font-size: .82rem;
  padding: 4px 10px; border: 1px solid var(--red); border-radius: 20px;
  transition: background var(--transition);
}
.summary-btn:hover { background: var(--red-light); }
.more-menu-wrap { position: relative; display: inline-block; margin-left: auto; }
.more-btn {
  width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border);
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 1rem; color: var(--ink-tertiary); cursor: pointer;
  transition: background var(--transition), border-color var(--transition);
  letter-spacing: 1px;
}
.more-btn:hover { background: var(--surface); border-color: var(--ink-faint); }
.more-dropdown {
  position: absolute; right: 0; top: calc(100% + 6px); min-width: 180px;
  background: var(--white); border: 1px solid var(--border); border-radius: 8px;
  box-shadow: 0 6px 20px rgba(0,0,0,.1); z-index: 200;
  display: none; flex-direction: column; overflow: hidden;
}
.more-dropdown.show { display: flex; }
.more-dropdown button {
  padding: 11px 16px; font-size: .87rem; text-align: left; cursor: pointer;
  color: var(--ink); transition: background var(--transition);
}
.more-dropdown button:hover { background: var(--surface); }

.article-hero-img {
  width: 100%; aspect-ratio: 16/9; object-fit: cover;
  border-radius: 6px; margin: 16px 0 24px; display: block;
}

/* Video cluster on homepage */
.video-cluster-section { margin-bottom: 40px; }
.video-strip {
  display: flex; gap: 16px; overflow-x: auto; padding-bottom: 8px;
  scrollbar-width: thin; scrollbar-color: var(--border) transparent;
}
.video-strip::-webkit-scrollbar { height: 4px; }
.video-strip::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
.video-strip-item { flex: 0 0 220px; cursor: pointer; }
.video-strip-item:hover .v-play { background: var(--red); }
.v-thumb-wrap {
  position: relative; width: 100%; aspect-ratio: 16/9; overflow: hidden;
  border-radius: 6px; background: var(--surface);
}
.v-thumb { width: 100%; height: 100%; object-fit: cover; display: block; }
.v-play {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
  width: 42px; height: 42px; background: rgba(0,0,0,.65); border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-size: 17px; pointer-events: none;
  transition: background .2s;
}
.v-duration {
  position: absolute; bottom: 6px; right: 8px;
  background: rgba(0,0,0,.7); color: #fff;
  font-size: .7rem; padding: 1px 5px; border-radius: 3px; font-weight: 600;
}
.v-title {
  font-size: .85rem; font-weight: 600; color: var(--ink);
  margin-top: 8px; line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}

.article-title {
  font-family: var(--font-headline); font-size: 2rem; font-weight: 700;
  line-height: 1.3; margin-bottom: 12px; color: var(--ink);
}
.article-sapo {
  font-size: 1.05rem; font-weight: 600; line-height: 1.6;
  color: var(--ink); margin-bottom: 20px;
  padding-left: 16px; border-left: 3px solid var(--red);
}
.article-body {
  font-size: 1rem; line-height: 1.8; color: var(--ink-secondary);
  margin-bottom: 24px;
}
.article-author, .article-source {
  text-align: right; font-size: .87rem; color: var(--ink-tertiary);
}
.article-author { font-weight: 600; margin-bottom: 2px; }
.article-source { margin-bottom: 32px; }

/* AI Q&A */
.ai-questions { margin-bottom: 32px; }
.ai-questions h3 {
  font-size: .95rem; font-weight: 700; color: var(--ink);
  margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
}
.ai-questions h3 .ai-badge {
  font-size: .7rem; background: var(--red); color: var(--white);
  padding: 2px 8px; border-radius: 10px; font-weight: 600; letter-spacing: .03em;
}
.ai-q-card {
  border: 1px solid var(--border); border-radius: 8px;
  margin-bottom: 8px; overflow: hidden;
  transition: border-color var(--transition);
}
.ai-q-card:hover { border-color: var(--red); }
.ai-q-trigger {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px; font-size: .9rem; font-weight: 500;
  cursor: pointer; width: 100%; text-align: left;
  transition: background var(--transition);
}
.ai-q-trigger:hover { background: var(--surface); }
.ai-q-trigger .arrow {
  font-size: .7rem; transition: transform .3s; color: var(--ink-tertiary);
}
.ai-q-card.open .ai-q-trigger .arrow { transform: rotate(180deg); }
.ai-q-answer {
  max-height: 0; overflow: hidden;
  transition: max-height .4s ease, padding .3s;
}
.ai-q-card.open .ai-q-answer {
  max-height: 200px; padding: 0 16px 14px;
}
.ai-q-answer p {
  font-size: .87rem; line-height: 1.6; color: var(--ink-secondary);
  padding-top: 8px; border-top: 1px solid var(--border-light);
}

/* Utilities */
.utilities-section { margin-bottom: 32px; }
.utilities-section h3 { font-size: .95rem; font-weight: 700; margin-bottom: 12px; }
.utilities-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
}
.utility-card {
  display: flex; flex-direction: column; align-items: center; gap: 6px;
  padding: 14px 8px; border: 1px solid var(--border); border-radius: 8px;
  font-size: .78rem; text-align: center; color: var(--ink-secondary);
  transition: border-color var(--transition), background var(--transition);
}
.utility-card:hover { border-color: var(--red); background: var(--red-light); }
.utility-icon { font-size: 1.5rem; }

/* Related sections */
.related-section { margin-bottom: 32px; }
.related-section .section-head { margin-bottom: 12px; }
.related-list .article-row:last-child { border-bottom: none; }
.btn-more {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 20px; border: 1px solid var(--border); border-radius: var(--radius);
  font-size: .85rem; color: var(--ink-secondary); margin-top: 12px;
  transition: all var(--transition);
}
.btn-more:hover { border-color: var(--red); color: var(--red); }

/* Most read */
.most-read-list { counter-reset: rank; }
.most-read-item {
  display: flex; align-items: baseline; gap: 12px;
  padding: 10px 0; border-bottom: 1px solid var(--border-light);
  cursor: pointer;
}
.most-read-item:hover .mr-title { color: var(--red); }
.most-read-item::before {
  counter-increment: rank; content: counter(rank);
  font-family: var(--font-headline); font-size: 1.5rem; font-weight: 700;
  color: var(--red); min-width: 28px;
}
.mr-title { font-weight: 600; font-size: .9rem; line-height: 1.4; }

/* Sticky bottom */
.sticky-bottom {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--white); border-top: 1px solid var(--border);
  box-shadow: 0 -2px 12px rgba(0,0,0,.06);
  z-index: 80; display: none;
}
.sticky-bottom.visible { display: block; }
.sticky-inner {
  max-width: 780px; margin: 0 auto;
  display: flex; align-items: center; gap: 12px;
  padding: 10px var(--gutter);
}
.sticky-input {
  flex: 1; padding: 10px 16px;
  border: 1px solid var(--border); border-radius: 24px;
  font-size: .87rem; font-family: var(--font-body);
  transition: border-color var(--transition);
}
.sticky-input:focus { outline: none; border-color: var(--red); }
.sticky-icons { display: flex; gap: 4px; }
.sticky-icon-btn {
  width: 38px; height: 38px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem; transition: background var(--transition);
}
.sticky-icon-btn:hover { background: var(--surface); }
.sticky-icon-btn.liked { color: var(--red); }

/* Latest news overlay */
.latest-overlay {
  display: none; position: fixed; inset: 0; z-index: 150;
  background: rgba(0,0,0,.4);
}
.latest-overlay.show { display: flex; justify-content: center; padding-top: 60px; }
.latest-panel {
  background: var(--white); width: 700px; max-height: 80vh;
  border-radius: 12px; overflow-y: auto; box-shadow: var(--shadow-md);
}
.latest-panel-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 24px; border-bottom: 2px solid var(--red);
  position: sticky; top: 0; background: var(--white); z-index: 1;
}
.latest-panel-header h2 { font-size: 1.1rem; font-weight: 700; color: var(--red); }
.latest-panel-close {
  width: 32px; height: 32px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; transition: background var(--transition);
}
.latest-panel-close:hover { background: var(--surface); }
.latest-panel-body { padding: 0 24px 24px; }

/* Local news overlay */
.local-overlay {
  display: none; position: fixed; inset: 0; z-index: 150;
  background: rgba(0,0,0,.4);
}
.local-overlay.show { display: flex; justify-content: center; padding-top: 60px; }
.local-panel {
  background: var(--white); width: 700px; max-height: 80vh;
  border-radius: 12px; overflow-y: auto; box-shadow: var(--shadow-md);
}
.local-panel-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 24px; border-bottom: 2px solid var(--red);
  position: sticky; top: 0; background: var(--white); z-index: 1;
}
.local-panel-header h2 { font-size: 1.1rem; font-weight: 700; color: var(--red); }
.local-panel-close {
  width: 32px; height: 32px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; transition: background var(--transition);
}
.local-panel-close:hover { background: var(--surface); }
.local-cities-bar {
  display: flex; gap: 8px; padding: 12px 24px; border-bottom: 1px solid var(--border);
}
.local-city-btn {
  padding: 6px 16px; border: 1px solid var(--border); border-radius: 20px;
  font-size: .82rem; font-weight: 500; transition: all var(--transition);
}
.local-city-btn:hover, .local-city-btn.active {
  background: var(--red); color: var(--white); border-color: var(--red);
}
.local-panel-body { padding: 0 24px 24px; }

/* ============================================================
   THƯ VIỆN PAGE
   ============================================================ */
.lib-header {
  background: var(--white); border-bottom: 1px solid var(--border);
  position: sticky; top: 103px; z-index: 50;
}
.lib-header-inner {
  max-width: var(--max-w); margin: 0 auto; padding: 16px var(--gutter) 0;
}
.lib-title { font-family: var(--font-headline); font-size: 1.15rem; font-weight: 700; color: var(--ink); margin-bottom: 14px; }
.lib-title span { color: var(--red); }
.lib-search-row {
  display: flex; gap: 8px; margin-bottom: 0;
}
.lib-search-input {
  flex: 1; padding: 10px 16px; border: 2px solid var(--border); border-radius: 8px;
  font-size: .95rem; font-family: var(--font-body); outline: none;
  transition: border-color var(--transition);
}
.lib-search-input:focus { border-color: var(--red); }
.lib-search-btn {
  padding: 10px 20px; background: var(--red); color: #fff; border-radius: 8px;
  font-weight: 600; font-size: .9rem; cursor: pointer; transition: background var(--transition);
}
.lib-search-btn:hover { background: #c62828; }
/* Tab bar */
.lib-tabs-bar {
  display: flex; gap: 0; border-bottom: 1px solid var(--border);
  background: var(--white);
}
.lib-tab {
  padding: 11px 20px; font-size: .88rem; font-weight: 600; color: var(--ink-secondary);
  cursor: pointer; border-bottom: 2px solid transparent; transition: color var(--transition);
  white-space: nowrap;
}
.lib-tab:hover { color: var(--red); }
.lib-tab.active { color: var(--red); border-bottom-color: var(--red); }
/* Body */
.lib-body { padding: 24px var(--gutter); max-width: var(--max-w); margin: 0 auto; }
/* Trending chips */
.lib-trending { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; align-items: center; }
.lib-trending-label { font-size: .8rem; color: var(--ink-tertiary); font-weight: 600; }
.lib-chip {
  padding: 4px 14px; border: 1px solid var(--border); border-radius: 20px;
  font-size: .82rem; cursor: pointer; transition: all var(--transition);
}
.lib-chip:hover { background: var(--red); color: #fff; border-color: var(--red); }
/* Topic grid */
.lib-topic-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 24px;
}
.lib-topic-card {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 20px 12px; border-radius: 10px; cursor: pointer;
  transition: transform var(--transition), box-shadow var(--transition);
  border: 1px solid var(--border); gap: 8px; text-align: center;
}
.lib-topic-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); }
.lib-topic-icon { font-size: 1.8rem; line-height: 1; }
.lib-topic-name { font-size: .85rem; font-weight: 600; color: var(--ink); }
/* Search results layout */
.lib-search-layout {
  display: grid; grid-template-columns: 1fr 320px; gap: 24px;
}
.lib-results-list { display: flex; flex-direction: column; gap: 0; }
.lib-result-item {
  padding: 14px 0; border-bottom: 1px solid var(--border-light); cursor: pointer;
}
.lib-result-item:last-child { border-bottom: none; }
.lib-result-cat {
  font-size: .72rem; font-weight: 700; color: var(--red); text-transform: uppercase;
  letter-spacing: .04em; margin-bottom: 4px;
}
.lib-result-title {
  font-size: .95rem; font-weight: 700; color: var(--ink); line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  margin-bottom: 4px;
}
.lib-result-title:hover { color: var(--red); }
.lib-result-sapo {
  font-size: .82rem; color: var(--ink-secondary);
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
/* AI summary box */
.lib-ai-box {
  background: linear-gradient(135deg, #f0f7ff 0%, #e8f2ff 100%);
  border: 1px solid #bdd6f7; border-radius: 12px; padding: 18px;
  position: sticky; top: 0;
}
.lib-ai-box-title {
  display: flex; align-items: center; gap: 6px;
  font-family: var(--font-headline); font-size: .9rem; font-weight: 700; color: var(--red);
  margin-bottom: 10px;
}
.lib-ai-sparkle { font-size: 1rem; }
.lib-ai-content {
  font-size: .86rem; color: var(--ink); line-height: 1.7; margin-bottom: 12px;
}
.lib-ai-sources { margin-top: 10px; border-top: 1px solid #ffd0d0; padding-top: 10px; }
.lib-ai-sources-title { font-size: .75rem; font-weight: 700; color: var(--ink-tertiary); margin-bottom: 6px; }
.lib-ai-source-link {
  display: block; font-size: .8rem; color: var(--red);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px;
  cursor: pointer;
}
.lib-ai-source-link:hover { text-decoration: underline; }
.lib-ai-badge {
  margin-top: 12px; font-size: .7rem; color: var(--ink-tertiary);
  text-align: right; font-style: italic;
}
/* AI Chat */
.lib-chat-wrap { display: flex; flex-direction: column; height: 100%; min-height: 400px; }
.lib-chat-messages {
  flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 16px;
  padding-bottom: 16px; margin-bottom: 16px;
}
.lib-chat-bubble {
  max-width: 75%; padding: 12px 16px; border-radius: 12px;
  font-size: .88rem; line-height: 1.6;
}
.lib-chat-bubble.user {
  align-self: flex-end; background: var(--red); color: #fff;
  border-bottom-right-radius: 3px;
}
.lib-chat-bubble.ai {
  align-self: flex-start; background: var(--surface); color: var(--ink);
  border-bottom-left-radius: 3px; border: 1px solid var(--border);
}
.lib-chat-bubble.ai strong { color: var(--red); }
.lib-chat-bubble.typing { opacity: .6; font-style: italic; }
.lib-chat-input-row { display: flex; gap: 8px; flex-shrink: 0; }
.lib-chat-input {
  flex: 1; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px;
  font-size: .9rem; font-family: var(--font-body); outline: none;
  transition: border-color var(--transition);
}
.lib-chat-input:focus { border-color: var(--red); }
.lib-chat-send {
  padding: 10px 18px; background: var(--red); color: #fff; border-radius: 8px;
  font-weight: 600; cursor: pointer; transition: background var(--transition);
}
.lib-chat-send:hover { background: #c62828; }
.lib-no-results { text-align: center; padding: 48px 24px; color: var(--ink-tertiary); font-size: .9rem; }

/* ============================================================
   FOOTER
   ============================================================ */
.site-footer {
  background: var(--ink); color: var(--white); padding: 32px 0;
  margin-top: 48px;
}
.footer-inner {
  max-width: var(--max-w); margin: 0 auto; padding: 0 var(--gutter);
  text-align: center; font-size: .82rem; color: var(--ink-faint);
}
.footer-inner .f-logo { font-family: var(--font-headline); font-size: 1.3rem; font-weight: 700; color: var(--white); margin-bottom: 8px; }

/* ============================================================
   HORIZONTAL ARTICLE CARD
   ============================================================ */
.card-h {
  display: flex; gap: 12px; align-items: flex-start;
  cursor: pointer; transition: opacity var(--transition);
}
.card-h:hover { opacity: .85; }
.card-h .h-ava {
  flex-shrink: 0; object-fit: cover;
  border-radius: var(--radius); background: var(--surface);
}
.card-h.h-large .h-ava { width: 45%; aspect-ratio: 16/9; }
.card-h.h-medium .h-ava { width: 40%; aspect-ratio: 4/3; }
.card-h .h-info { flex: 1; min-width: 0; }
.card-h .title {
  font-family: var(--font-headline); font-weight: 700; line-height: 1.35; color: var(--ink);
  display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
}
.card-h .title:hover { color: var(--red); }
.card-h .sapo {
  font-size: .87rem; color: var(--ink-secondary); margin-top: 4px; line-height: 1.5;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}

/* ============================================================
   ARTICLE QUICK ICONS (AI + Audio overlays on cards)
   ============================================================ */
.article-row { position: relative; }
.card-h { position: relative; }
.article-card { position: relative; }
.title-only-card { position: relative; }
.art-quick-icons {
  position: absolute; bottom: 6px; right: 6px;
  display: flex; gap: 3px; align-items: center; z-index: 5;
  opacity: 0; transition: opacity .18s;
}
.article-row:hover .art-quick-icons,
.card-h:hover .art-quick-icons,
.article-card:hover .art-quick-icons,
.title-only-card:hover .art-quick-icons { opacity: 1; }
.art-icon-btn {
  width: 26px; height: 26px; border-radius: 50%;
  background: rgba(255,255,255,.93); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: .65rem; cursor: pointer;
  box-shadow: 0 1px 5px rgba(0,0,0,.18); transition: all .18s; padding: 0; line-height: 1;
}
.art-icon-btn:hover { background: var(--red); color: #fff; border-color: var(--red); }
/* AI Summary Popup */
.art-summary-popup {
  position: fixed; max-width: 300px; width: 88vw;
  background: var(--white); border: 1px solid var(--border);
  border-radius: 12px; padding: 14px 16px; z-index: 5000;
  box-shadow: 0 8px 32px rgba(0,0,0,.15); display: none;
}
.art-summary-popup.open { display: block; }
.art-summary-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
}
.art-summary-badge { font-size: .78rem; font-weight: 700; color: var(--red); letter-spacing: .02em; }
#artSummaryClose { font-size: 1rem; color: var(--ink-tertiary); cursor: pointer; background: none; border: none; }
.art-summary-text { font-size: .83rem; color: var(--ink-secondary); line-height: 1.55; }

/* ============================================================
   ANIMATIONS
   ============================================================ */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-up { animation: fadeUp .5s ease both; }

/* ============================================================
   PRESENT MODE
   ============================================================ */
.present-toggle-btn {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 13px;
  background: transparent;
  border: 1.5px solid #E53935;
  border-radius: 20px;
  color: #E53935;
  font-size: 0.77rem; font-weight: 700; font-family: inherit;
  cursor: pointer; transition: all 0.2s; letter-spacing: 0.03em;
}
.present-toggle-btn:hover { background: #FFEBEE; }
.present-toggle-btn.pm-on { background: #E53935; color: #fff; }
.present-toggle-btn .ptb-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: currentColor; display: inline-block; flex-shrink: 0;
}
.present-toggle-btn.pm-on .ptb-dot { animation: ptb-blink 1.1s ease-in-out infinite; }
@keyframes ptb-blink { 0%,100%{opacity:1} 50%{opacity:.25} }

.present-annotated.present-lit {
  outline: 3px solid #E53935;
  outline-offset: 5px;
  border-radius: 6px;
  box-shadow: 0 0 0 9px rgba(229,57,53,0.08);
  animation: present-glow 2.4s ease-in-out infinite;
}
@keyframes present-glow {
  0%,100%{ box-shadow: 0 0 0 9px rgba(229,57,53,0.08); }
  50%{ box-shadow: 0 0 0 16px rgba(229,57,53,0.03); }
}

/* Present mode: fixed right-side panel with stacked cards */
.pm-panel {
  position: fixed; right: 16px; top: 72px; z-index: 10001;
  display: flex; flex-direction: column; gap: 8px;
  pointer-events: none; max-height: calc(100vh - 100px);
}
.pm-card {
  width: 262px; background: #fff; border-radius: 12px;
  border-left: 4px solid #E53935; padding: 13px 15px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.16), 0 2px 8px rgba(0,0,0,0.07);
  pointer-events: auto; font-family: 'Noto Sans', sans-serif;
  animation: pp-in 0.22s ease both;
}
@keyframes pp-in {
  from { opacity:0; transform: scale(.95) translateX(10px); }
  to   { opacity:1; transform: scale(1)  translateX(0); }
}
.pm-card-close {
  float: right; background: none; border: none; color: #bbb;
  font-size: 1.05rem; cursor: pointer; padding: 0 0 6px 6px; line-height: 1;
}
.pm-card-close:hover { color: #444; }
.pm-card-title { font-weight: 700; font-size: 0.87rem; color: #111; line-height: 1.35; margin-bottom: 6px; }
.pm-card-desc { font-size: 0.79rem; color: #555; line-height: 1.58; }
</style>
</head>
<body>

<!-- ============================================================
     HEADER
     ============================================================ -->
<header class="site-header">
  <div class="header-inner">
    <a href="#home" class="logo">
      <img src="v-app logo.png" alt="VTimes">
      <span class="logo-text">VTimes</span>
    </a>
    <button class="present-toggle-btn" id="presentToggleBtn" onclick="togglePresent()"><span class="ptb-dot"></span> Present</button>
    <button class="hamburger-btn" id="hamburgerBtn" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
  </div>
</header>

<!-- ============================================================
     TICKER
     ============================================================ -->
<div class="ticker-bar">
  <div class="ticker-track" id="tickerTrack"></div>
</div>

<!-- ============================================================
     NAVIGATION
     ============================================================ -->
<nav class="main-nav">
  <div class="nav-inner" id="navInner"></div>
</nav>
<div class="web-cat-subs-bar" id="webCatSubsBar"></div>

<!-- ============================================================
     QUAN TÂM OVERLAY
     ============================================================ -->
<div class="local-overlay" id="quantamOverlay">
  <div class="local-panel" style="width:600px;">
    <div class="local-panel-header">
      <h2>Chủ đề quan tâm</h2>
      <button class="local-panel-close" id="quantamClose">&times;</button>
    </div>
    <div style="padding:16px 24px 8px;">
      <p style="font-size:.85rem;color:var(--ink-secondary);margin-bottom:12px;">Chọn các chủ đề bạn muốn theo dõi:</p>
      <div id="quantamCheckboxes" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px 16px;margin-bottom:16px;"></div>
      <button id="quantamApply" style="width:100%;padding:10px;background:var(--red);color:#fff;border-radius:4px;font-weight:600;font-size:.9rem;cursor:pointer;">Xem tin đã chọn</button>
    </div>
    <div class="local-panel-body" id="quantamBody"></div>
  </div>
</div>

<!-- ============================================================
     HAMBURGER OVERLAY
     ============================================================ -->
<div class="menu-overlay" id="menuOverlay">
  <div class="menu-backdrop" id="menuBackdrop"></div>
  <div class="menu-panel">
    <div class="menu-header">
      <span class="logo-text" style="color:var(--red)">VTimes</span>
      <button class="menu-close" id="menuClose">&times;</button>
    </div>
    <div class="menu-list" id="menuList"></div>
  </div>
</div>

<!-- ============================================================
     LATEST NEWS OVERLAY
     ============================================================ -->
<div class="latest-overlay" id="latestOverlay">
  <div class="latest-panel">
    <div class="latest-panel-header">
      <h2>Tin mới nhất</h2>
      <button class="latest-panel-close" id="latestClose">&times;</button>
    </div>
    <div class="latest-panel-body" id="latestBody"></div>
  </div>
</div>

<!-- ============================================================
     LOCAL NEWS OVERLAY
     ============================================================ -->
<div class="local-overlay" id="localOverlay">
  <div class="local-panel">
    <div class="local-panel-header">
      <h2>Tin địa phương</h2>
      <button class="local-panel-close" id="localClose">&times;</button>
    </div>
    <div class="local-cities-bar" id="localCities"></div>
    <div class="local-panel-body" id="localBody"></div>
  </div>
</div>

<!-- ============================================================
     THƯ VIỆN OVERLAY
     ============================================================ -->
<!-- ============================================================
     PAGE: LIBRARY
     ============================================================ -->
<div id="page-library" class="page">
  <div class="lib-header" id="libHeader">
    <div class="lib-header-inner">
      <div class="lib-title">📚 <span>Bách khoa tri thức</span> VTimes</div>
      <div class="lib-tabs-bar">
        <div class="lib-tab active" data-tab="topics">Chủ đề</div>
        <div class="lib-tab" data-tab="search">Tra cứu</div>
        <div class="lib-tab" data-tab="ai">✦ Hỏi AI</div>
      </div>
    </div>
  </div>
  <div class="lib-body" id="libBody"></div>
</div>

<!-- ============================================================
     PAGE: HOME
     ============================================================ -->
<div id="page-home" class="page">
  <div class="container">
    <div class="top-cluster" id="topCluster"></div>
    <div class="home-main">
      <div class="home-left" id="homeLeft"></div>
      <div class="home-right" id="homeRight"></div>
    </div>
    <div class="video-cluster-section" id="homeVideoCluster"></div>
    <div class="remaining-cats" id="remainingCats"></div>
  </div>
</div>

<!-- ============================================================
     PAGE: CATEGORY
     ============================================================ -->
<div id="page-category" class="page">
  <div class="container" id="catNormalContainer">
    <div id="catSpecial"></div>
    <div class="cat-top-cluster" id="catTopCluster"></div>
    <div class="cat-main-grid" id="catMainGrid">
      <div class="cat-left" id="catLeft"></div>
      <div class="cat-right" id="catRight"></div>
    </div>
    <div class="cat-stream" id="catStream"></div>
  </div>
</div>

<!-- VIDEO FEED PAGE (dark, snap-scroll) -->
<div id="videoFeedPage">
  <div class="vf-header">
    <h2>▶ Video</h2>
    <span class="vf-header-sub">Cuộn để xem video tiếp theo · Click để phóng to</span>
  </div>
  <div class="vf-feed" id="vfFeed"></div>
</div>

<!-- VIDEO LIGHTBOX -->
<div class="video-lightbox" id="videoLightbox">
  <button class="vlb-close" id="vlbClose">✕</button>
  <div class="vlb-carousel" id="vlbCarousel"></div>
  <div class="vlb-note">← → Kéo hoặc cuộn ngang để xem tiếp · Video sẽ phát khi tích hợp nguồn thật</div>
</div>

<!-- ============================================================
     PAGE: ARTICLE
     ============================================================ -->
<div id="page-article" class="page">
  <div class="article-detail" id="articleDetail"></div>
</div>

<!-- STICKY BOTTOM (article page only) -->
<div class="sticky-bottom" id="stickyBottom">
  <div class="sticky-inner">
    <input type="text" class="sticky-input" placeholder="Hỏi tiếp về tin này...">
    <div class="sticky-icons">
      <button class="sticky-icon-btn" id="btnLike" title="Yêu thích">&#10084;</button>
      <button class="sticky-icon-btn" id="btnSave" title="Lưu bài">&#128278;</button>
      <button class="sticky-icon-btn" id="btnShare" title="Chia sẻ">&#128279;</button>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer class="site-footer">
  <div class="footer-inner">
    <div class="f-logo">VTimes</div>
    <p>Trang thông tin điện tử VTimes &copy; 2026. Prototype Demo.</p>
  </div>
</footer>

<!-- ============================================================
     DATA + APP JS
     ============================================================ -->
<script src="real-articles.js"></script>
<script src="data.js"></script>
<script>
(function() {
  'use strict';
  const D = window.VAPP;

  // ============================================================
  // HELPERS
  // ============================================================
  function $(sel, ctx) { return (ctx || document).querySelector(sel); }
  function $$(sel, ctx) { return Array.from((ctx || document).querySelectorAll(sel)); }
  function el(tag, cls, html) {
    const e = document.createElement(tag);
    if (cls) e.className = cls;
    if (html !== undefined) e.innerHTML = html;
    return e;
  }

  // Quick icons: AI summary + audio, overlaid on article cards
  function quickIconsHTML(a) {
    const sapo = (a.sapo || '').replace(/"/g, '&quot;');
    return `<div class="art-quick-icons">
      <button class="art-icon-btn art-audio-btn" data-art-id="${a.id}" title="Nghe bài">🔊</button>
      <button class="art-icon-btn art-ai-btn" data-art-id="${a.id}" data-sapo="${sapo}" title="Tóm tắt AI">✦</button>
    </div>`;
  }

  function articleCardHTML(a, opts = {}) {
    const showAva = opts.ava !== false;
    const avaClass = opts.avaClass || 'ava';
    const titleSize = opts.titleSize || '';
    const showSapo = opts.sapo !== false;
    const showTime = opts.time === true;
    let h = '';
    if (showAva) h += `<img class="${avaClass}" src="${a.avaUrl}" alt="" loading="lazy">`;
    h += `<div class="title" style="${titleSize ? 'font-size:'+titleSize : ''}">${a.title}</div>`;
    if (showSapo) h += `<div class="sapo">${a.sapo}</div>`;
    if (showTime) h += `<div class="meta-time">${a.time}</div>`;
    h += quickIconsHTML(a);
    return h;
  }

  function articleRowHTML(a) {
    return `<img class="ava-thumb" src="${a.avaUrl}" alt="" loading="lazy">
      <div class="info">
        <div class="title">${a.title}</div>
        <div class="sapo">${a.sapo}</div>
      </div>
      ${quickIconsHTML(a)}`;
  }

  function titleOnlyHTML(a) {
    return `<div class="title">${a.title}</div><div class="sapo">${a.sapo}</div>${quickIconsHTML(a)}`;
  }

  // Create a horizontal card element (ava left + title/sapo right)
  function makeCardH(a, opts = {}) {
    const sizeClass = opts.large ? 'h-large' : 'h-medium';
    const extraClass = opts.extraClass || '';
    const titleSize = opts.titleSize || '';
    const div = el('div', `card-h ${sizeClass} ${extraClass}`);
    div.innerHTML = `<img class="h-ava" src="${a.avaUrl}" alt="" loading="lazy">
      <div class="h-info">
        <div class="title"${titleSize ? ' style="font-size:'+titleSize+'"' : ''}>${a.title}</div>
        <div class="sapo">${a.sapo}</div>
      </div>
      ${quickIconsHTML(a)}`;
    makeClickable(div, a);
    return div;
  }

  function goArticle(a) { location.hash = `#article/${a.id}`; }
  function goCategory(catId, subId) {
    location.hash = subId ? `#category/${catId}/${subId}` : `#category/${catId}`;
  }

  function makeClickable(elem, a) {
    const handler = () => goArticle(a);
    const title = elem.querySelector('.title');
    const img = elem.querySelector('img');
    if (title) { title.style.cursor = 'pointer'; title.addEventListener('click', handler); }
    if (img) { img.style.cursor = 'pointer'; img.addEventListener('click', handler); }
  }

  function findArticleById(id) {
    const num = parseInt(id);
    // search all pre-gen data
    const sources = [
      D.HOME_TOP_ARTICLES, D.HOME_LEFT_ARTICLES, D.MOST_READ_48H,
      D.MOBILE_TOP_5, D.MOBILE_MIX_1, D.MOBILE_MIX_2, D.MOBILE_MIX_3, D.MOBILE_MIX_4,
      D.MOBILE_VIDEO_ARTICLES, D.VIDEO_HOME_ARTICLES,
      ...Object.values(D.HOME_FEATURED),
      ...Object.values(D.HOME_REMAINING),
      ...Object.values(D.CATEGORY_ARTICLES),
      ...Object.values(D.MOBILE_CATEGORY_ARTICLES),
      ...Object.values(D.MOBILE_REMAINING)
    ];
    for (const arr of sources) {
      const found = arr.find(a => a.id === num);
      if (found) return found;
    }
    return D.HOME_TOP_ARTICLES[0];
  }

  // ============================================================
  // BUILD TICKER
  // ============================================================
  function buildTicker() {
    const t = D.TICKER_DATA;
    const items = [t.weather, t.date, t.lunarDate, t.gold, t.stock];
    let html = '';
    for (let i = 0; i < 3; i++) {
      items.forEach(item => {
        html += `<span><span class="dot"></span> ${item}</span>`;
      });
    }
    $('#tickerTrack').innerHTML = html;
  }

  // ============================================================
  // BUILD NAV
  // ============================================================
  function buildNav() {
    const nav = $('#navInner');

    // Fixed pinned group (never scrolls)
    const fixedGroup = el('div', 'nav-fixed-group');
    fixedGroup.innerHTML = `
      <a href="#home" class="nav-special-btn" style="font-size:1.1rem">🏠</a>
      <a href="javascript:void(0)" class="nav-special-btn" id="navLatest">Mới nhất</a>
      <a href="javascript:void(0)" class="nav-special-btn" id="navLocal">Địa phương ▾</a>
      <a href="javascript:void(0)" class="nav-special-btn" id="navQuantam">Quan tâm ▾</a>
      <a href="#library" class="nav-special-btn" style="border-right:none">📚 Bách khoa tri thức</a>`;

    // Scrollable category list
    const catsScroll = el('div', 'nav-cats-scroll');
    catsScroll.id = 'navCatsScroll';
    const catsInner = el('div', 'nav-cats-inner');
    catsInner.id = 'navCatsInner';
    D.CATEGORIES.forEach(cat => {
      const a = el('a', 'nav-cat-link');
      a.href = `#category/${cat.id}`;
      a.dataset.cat = cat.id;
      a.textContent = cat.name;
      catsInner.appendChild(a);
    });
    catsScroll.appendChild(catsInner);

    nav.innerHTML = '';
    nav.appendChild(fixedGroup);
    nav.appendChild(catsScroll);

    $('#navLatest').addEventListener('click', () => { showLatestNews(); });
    $('#navLocal').addEventListener('click', () => { showLocalNews(); });
    $('#navQuantam').addEventListener('click', () => { showQuantamPanel(); });
    // navLibrary navigates via href="#library"

    // Mouse drag to scroll
    enableDragScroll(catsScroll);
  }

  function enableDragScroll(el) {
    let isDown = false, startX, sl, didDrag = false;
    el.addEventListener('mousedown', e => {
      if (e.button !== 0) return;
      isDown = true; didDrag = false;
      startX = e.pageX; sl = el.scrollLeft;
    });
    document.addEventListener('mouseup', () => {
      if (!isDown) return;
      isDown = false;
      el.classList.remove('is-dragging');
    });
    el.addEventListener('mousemove', e => {
      if (!isDown) return;
      const dx = e.pageX - startX;
      if (Math.abs(dx) > 4) {
        didDrag = true;
        el.classList.add('is-dragging');
        el.scrollLeft = sl - dx;
      }
    });
    el.addEventListener('click', e => {
      if (didDrag) { e.preventDefault(); e.stopPropagation(); didDrag = false; }
    }, true);
  }

  // ============================================================
  // LATEST NEWS
  // ============================================================
  function showLatestNews() {
    const overlay = $('#latestOverlay');
    const body = $('#latestBody');
    // gather all articles, sort by time
    let all = [];
    Object.values(D.CATEGORY_ARTICLES).forEach(arr => { all = all.concat(arr); });
    all.sort((a, b) => {
      // parse dd/mm/yyyy hh:mm
      const pa = a.time.split(/[\/\s:]/); const pb = b.time.split(/[\/\s:]/);
      const da = new Date(2026, pa[1]-1, pa[0], pa[3], pa[4]);
      const db = new Date(2026, pb[1]-1, pb[0], pb[3], pb[4]);
      return db - da;
    });
    body.innerHTML = '';
    all.slice(0, 30).forEach(a => {
      const row = el('div', 'article-row');
      row.innerHTML = articleRowHTML(a);
      makeClickable(row, a);
      body.appendChild(row);
    });
    overlay.classList.add('show');
  }

  $('#latestClose').addEventListener('click', () => $('#latestOverlay').classList.remove('show'));
  $('#latestOverlay').addEventListener('click', e => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('show');
  });

  // ============================================================
  // LOCAL NEWS
  // ============================================================
  function showLocalNews() {
    const overlay = $('#localOverlay');
    const citiesBar = $('#localCities');
    const body = $('#localBody');
    citiesBar.innerHTML = '';
    D.LOCAL_CITIES.forEach((city, i) => {
      const btn = el('button', 'local-city-btn' + (i === 0 ? ' active' : ''), city);
      btn.addEventListener('click', () => {
        $$('.local-city-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderLocalArticles(body, city);
      });
      citiesBar.appendChild(btn);
    });
    renderLocalArticles(body, D.LOCAL_CITIES[0]);
    overlay.classList.add('show');
  }

  function renderLocalArticles(container, city) {
    container.innerHTML = '';
    const arts = D.generateArticles('thoi-su', 10);
    arts.forEach(a => {
      a.title = city + ': ' + a.title;
      const row = el('div', 'article-row');
      row.innerHTML = articleRowHTML(a);
      makeClickable(row, a);
      container.appendChild(row);
    });
  }

  $('#localClose').addEventListener('click', () => $('#localOverlay').classList.remove('show'));
  $('#localOverlay').addEventListener('click', e => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('show');
  });

  // ============================================================
  // QUAN TÂM (PERSONALIZATION)
  // ============================================================
  function showQuantamPanel() {
    const overlay = $('#quantamOverlay');
    const checkboxes = $('#quantamCheckboxes');
    checkboxes.innerHTML = '';
    D.CATEGORIES.forEach(cat => {
      const label = document.createElement('label');
      label.style.cssText = 'display:flex;align-items:center;gap:6px;font-size:.88rem;cursor:pointer;';
      label.innerHTML = `<input type="checkbox" value="${cat.id}" style="accent-color:var(--red);width:14px;height:14px;"> ${cat.name}`;
      checkboxes.appendChild(label);
    });
    $('#quantamBody').innerHTML = '';
    overlay.classList.add('show');
  }

  $('#quantamApply').addEventListener('click', () => {
    const checked = Array.from($('#quantamCheckboxes').querySelectorAll('input:checked')).map(i => i.value);
    const body = $('#quantamBody');
    body.innerHTML = '';
    if (!checked.length) {
      body.innerHTML = '<p style="padding:16px;color:var(--ink-secondary)">Vui lòng chọn ít nhất một chủ đề.</p>';
      return;
    }
    let arts = [];
    checked.forEach(catId => { arts = arts.concat(D.generateArticles(catId, 5)); });
    arts.sort((a, b) => {
      const pa = a.time.split(/[\/\s:]/); const pb = b.time.split(/[\/\s:]/);
      const da = new Date(2026, pa[1]-1, pa[0], pa[3], pa[4]);
      const db = new Date(2026, pb[1]-1, pb[0], pb[3], pb[4]);
      return db - da;
    });
    arts.forEach(a => {
      const row = el('div', 'article-row');
      row.innerHTML = articleRowHTML(a);
      makeClickable(row, a);
      body.appendChild(row);
    });
  });

  $('#quantamClose').addEventListener('click', () => $('#quantamOverlay').classList.remove('show'));
  $('#quantamOverlay').addEventListener('click', e => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('show');
  });

  // ============================================================
  // THƯ VIỆN (LIBRARY)
  // ============================================================
  const LIB_TOPICS = [
    { icon: '🔬', name: 'Khoa học',   color: '#7c3aed', key: 'khoa-hoc' },
    { icon: '🏛',  name: 'Lịch sử',   color: '#92400e', key: 'lich-su' },
    { icon: '🌍',  name: 'Địa lý',    color: '#065f46', key: 'dia-ly' },
    { icon: '⚖️', name: 'Pháp luật', color: '#1e3a8a', key: 'phap-luat' },
    { icon: '💊',  name: 'Sức khỏe',  color: '#0369a1', key: 'suc-khoe' },
    { icon: '💰',  name: 'Kinh tế',   color: '#92400e', key: 'kinh-te' },
    { icon: '🎭',  name: 'Văn hóa',   color: '#c2410c', key: 'van-hoa' },
    { icon: '🤖',  name: 'Công nghệ', color: '#be123c', key: 'cong-nghe' },
    { icon: '📐',  name: 'Toán học',  color: '#6d28d9', key: 'toan-hoc' },
    { icon: '🌱',  name: 'Môi trường',color: '#166534', key: 'moi-truong' },
    { icon: '🧬',  name: 'Sinh học',  color: '#be185d', key: 'sinh-hoc' },
    { icon: '⚡',  name: 'Vật lý',    color: '#b45309', key: 'vat-ly' },
  ];

  const LIB_TRENDING = ['Lạm phát', 'Trí tuệ nhân tạo', 'Biến đổi khí hậu', 'Hiệp định thương mại', 'Cách mạng công nghiệp', 'Năng lượng tái tạo'];

  const LIB_AI_STARTERS = ['Lạm phát là gì?', 'Biến đổi khí hậu ảnh hưởng thế nào?', 'AI hoạt động ra sao?', 'Tại sao cần năng lượng tái tạo?'];

  let libChatHistory = [];

  function renderLibrary() {
    libChatHistory = [];
    const page = $('#page-library');
    page.querySelectorAll('.lib-tab').forEach(tab => {
      tab.onclick = () => {
        page.querySelectorAll('.lib-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const which = tab.dataset.tab;
        if (which === 'topics') renderLibTopicsTab();
        else if (which === 'search') renderLibSearchTab('');
        else if (which === 'ai') renderLibAITab();
      };
    });
    page.querySelectorAll('.lib-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === 'topics'));
    renderLibTopicsTab();
  }

  function libSetActiveTab(name) {
    $('#page-library').querySelectorAll('.lib-tab').forEach(t => {
      t.classList.toggle('active', t.dataset.tab === name);
    });
  }

  function libDoSearch(q) {
    if (!q) return;
    libSetActiveTab('search');
    renderLibSearchTab(q);
  }

  function renderLibTopicsTab() {
    const body = $('#libBody');
    // Trending chips
    const chips = LIB_TRENDING.map(t =>
      `<span class="lib-chip" onclick="libDoSearch('${t}')">${t}</span>`
    ).join('');
    // Topic grid
    const cards = LIB_TOPICS.map(tp =>
      `<div class="lib-topic-card" style="--topic-color:${tp.color}" onclick="libDoSearch('${tp.name}')">
        <div class="lib-topic-icon">${tp.icon}</div>
        <div class="lib-topic-name">${tp.name}</div>
      </div>`
    ).join('');
    body.innerHTML = `
      <div style="padding:20px 24px 0">
        <div class="lib-trending">
          <span style="font-size:.8rem;color:var(--ink-secondary);font-weight:600;margin-right:8px">Xu hướng:</span>
          ${chips}
        </div>
      </div>
      <div style="padding:16px 24px 24px">
        <div style="font-size:.82rem;color:var(--ink-secondary);font-weight:700;letter-spacing:.06em;margin-bottom:12px">KHÁM PHÁ CHỦ ĐỀ</div>
        <div class="lib-topic-grid">${cards}</div>
      </div>`;
  }

  function renderLibSearchTab(q) {
    libSetActiveTab('search');
    const body = $('#libBody');

    let resultsHTML = '';
    if (!q) {
      const specialSubs = [
        {special: 'war-map'}, {special: 'traffic-fine'}, {special: 'stock-search'},
        {special: 'ebank-search'}, {special: 'project-search'}, {special: 'quyhoach-search'},
        {special: 'disease-search'}, {special: 'law-search'}, {special: 'exam-search'},
        {special: 'destination-search'}, {special: 'thietbi-search'},
      ];
      resultsHTML = `<div style="padding:4px 24px 16px">
        <div style="font-size:.82rem;font-weight:600;color:var(--ink-secondary);margin-bottom:12px;letter-spacing:.03em;text-transform:uppercase">Công cụ tra cứu chuyên biệt</div>
        ${specialSubs.map(s => buildSpecialBox(s)).join('')}
      </div>`;
    } else {
      const ql = q.toLowerCase();
      let matches = [];
      Object.values(D.CATEGORY_ARTICLES).forEach(arr => {
        arr.forEach(a => {
          if ((a.title && a.title.toLowerCase().includes(ql)) || (a.sapo && a.sapo.toLowerCase().includes(ql))) {
            matches.push(a);
          }
        });
      });
      const seen = new Set();
      matches = matches.filter(a => { if (seen.has(a.id)) return false; seen.add(a.id); return true; });

      const resultHTML = matches.length
        ? matches.slice(0, 20).map(a => `
            <div class="lib-result-item" onclick="goArticle(${JSON.stringify(a).replace(/"/g, '&quot;')})">
              <div class="lib-result-title">${a.title}</div>
              <div class="lib-result-meta">${a.categoryName || ''} · ${a.time || ''}</div>
            </div>`).join('')
        : `<div class="lib-no-results">Không tìm thấy kết quả cho "<strong>${q}</strong>".</div>`;

      const aiSummary = `<div class="lib-ai-box">
        <div class="lib-ai-label">✦ VTimes AI · Tóm tắt</div>
        <div class="lib-ai-text">Theo VTimes AI, <strong>"${q}"</strong> là một chủ đề quan trọng được đề cập trong nhiều lĩnh vực. Dựa trên các bài viết hiện có, đây là những thông tin nổi bật bạn nên biết: chủ đề này liên quan đến các xu hướng đang thay đổi trong xã hội, ảnh hưởng đến đời sống và kinh tế. Các chuyên gia nhận định đây là vấn đề cần được quan tâm và theo dõi thường xuyên.</div>
        <div style="margin-top:10px;font-size:.78rem;color:var(--ink-secondary)">✦ Powered by VTimes AI · Nội dung mang tính tham khảo</div>
      </div>`;

      resultsHTML = `
        <div style="padding:4px 24px 4px;font-size:.82rem;color:var(--ink-secondary)">
          ${matches.length} kết quả cho "<strong>${q}</strong>"
        </div>
        <div class="lib-search-layout">
          <div class="lib-results-col">${resultHTML}</div>
          <div class="lib-ai-col">${aiSummary}</div>
        </div>`;
    }

    body.innerHTML = `
      <div style="padding:16px 24px 12px">
        <div class="lib-search-row">
          <input class="lib-search-input" id="libSearchInput" type="text" placeholder="Tìm chủ đề, từ khóa, câu hỏi..." value="${q ? q.replace(/"/g, '&amp;quot;') : ''}">
          <button class="lib-search-btn" id="libSearchBtn">Tìm</button>
        </div>
      </div>
      ${resultsHTML}`;

    const doSearch = () => libDoSearch($('#libSearchInput').value.trim());
    $('#libSearchBtn').onclick = doSearch;
    $('#libSearchInput').onkeydown = e => { if (e.key === 'Enter') doSearch(); };
    if (!q) {
      initWarMap();
      setTimeout(() => { const inp = $('#libSearchInput'); if (inp) inp.focus(); }, 50);
      setTimeout(() => { if (window.pmReinit) window.pmReinit(); }, 100);
    }
  }

  function renderLibAITab() {
    libSetActiveTab('ai');
    const body = $('#libBody');
    libChatHistory = [];
    const starterChips = LIB_AI_STARTERS.map(s =>
      `<span class="lib-chip" style="cursor:pointer" onclick="libSendChat('${s}')">${s}</span>`
    ).join('');
    body.innerHTML = `
      <div class="lib-chat-wrap">
        <div class="lib-chat-messages" id="libChatMessages">
          <div class="lib-ai-welcome">
            <div style="font-size:1.5rem;margin-bottom:8px">✦</div>
            <div style="font-weight:700;font-size:1rem;margin-bottom:4px">VTimes AI</div>
            <div style="font-size:.88rem;color:var(--ink-secondary);margin-bottom:16px">Hỏi bất cứ điều gì về khoa học, lịch sử, kinh tế...</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center">${starterChips}</div>
          </div>
        </div>
        <div class="lib-chat-input-row">
          <input class="lib-chat-input" id="libChatInput" type="text" placeholder="Hỏi VTimes AI...">
          <button class="lib-chat-send" id="libChatSend">Gửi</button>
        </div>
      </div>`;
    $('#libChatSend').onclick = () => { const v = $('#libChatInput').value.trim(); if (v) libSendChat(v); };
    $('#libChatInput').onkeydown = e => { if (e.key === 'Enter') { const v = $('#libChatInput').value.trim(); if (v) libSendChat(v); } };
  }

  function libSendChat(text) {
    const msgs = $('#libChatMessages');
    if (!msgs) return;
    // Hide welcome if present
    const welcome = msgs.querySelector('.lib-ai-welcome');
    if (welcome) welcome.remove();
    $('#libChatInput') && ($('#libChatInput').value = '');

    // User bubble
    const userBubble = el('div', 'lib-chat-bubble lib-chat-user');
    userBubble.textContent = text;
    msgs.appendChild(userBubble);

    // Typing indicator
    const typing = el('div', 'lib-chat-bubble lib-chat-ai lib-chat-typing');
    typing.innerHTML = '<span></span><span></span><span></span>';
    msgs.appendChild(typing);
    msgs.scrollTop = msgs.scrollHeight;

    // Simulated AI reply after 800ms
    setTimeout(() => {
      typing.remove();
      const reply = libGenerateAIReply(text);
      const aiBubble = el('div', 'lib-chat-bubble lib-chat-ai');
      aiBubble.innerHTML = reply;
      msgs.appendChild(aiBubble);
      msgs.scrollTop = msgs.scrollHeight;
    }, 900);
  }

  function libGenerateAIReply(q) {
    const ql = q.toLowerCase();
    // Match a known topic for a slightly tailored reply
    const matched = LIB_TOPICS.find(t => ql.includes(t.name.toLowerCase()) || ql.includes(t.key));
    const topicNote = matched ? `lĩnh vực <strong>${matched.name}</strong>` : 'nhiều lĩnh vực khác nhau';
    return `<div style="font-weight:700;margin-bottom:8px">✦ VTimes AI</div>
      <p style="margin:0 0 8px">Câu hỏi của bạn về <em>"${q}"</em> liên quan đến ${topicNote}.</p>
      <ul style="margin:0 0 8px;padding-left:18px">
        <li>Đây là chủ đề được nghiên cứu và ghi nhận rộng rãi trong học thuật và thực tiễn.</li>
        <li>Các chuyên gia thường nhìn nhận vấn đề này qua nhiều góc độ khác nhau.</li>
        <li>Để giải mã đa tầng hơn, bạn có thể dùng tab <strong>Tra cứu</strong> để xem các bài viết liên quan.</li>
      </ul>
      <div style="font-size:.78rem;color:var(--ink-secondary);margin-top:6px">✦ Powered by VTimes AI · Nội dung mang tính tham khảo</div>`;
  }



  // ============================================================
  // BUILD HAMBURGER MENU
  // ============================================================
  function buildMenu() {
    const list = $('#menuList');
    let html = '';
    D.CATEGORIES.forEach(cat => {
      html += `<div class="menu-cat">
        <a href="#category/${cat.id}" class="menu-cat-main">${cat.name}</a>
        <div class="menu-subs">`;
      cat.subs.forEach(sub => {
        html += `<a href="#category/${cat.id}/${sub.id}" class="menu-sub-link">${sub.name}</a>`;
      });
      html += `</div></div>`;
    });
    list.innerHTML = html;

    // close on link click
    list.addEventListener('click', e => {
      if (e.target.tagName === 'A') closeMenu();
    });
  }

  function openMenu() { $('#menuOverlay').classList.add('open'); document.body.style.overflow = 'hidden'; }
  function closeMenu() { $('#menuOverlay').classList.remove('open'); document.body.style.overflow = ''; }
  $('#hamburgerBtn').addEventListener('click', openMenu);
  $('#menuClose').addEventListener('click', closeMenu);
  $('#menuBackdrop').addEventListener('click', closeMenu);

  // ============================================================
  // RENDER HOME
  // ============================================================
  function renderHome() {
    $('#webCatSubsBar').style.display = 'none';
    // Top cluster
    const tc = $('#topCluster');
    tc.innerHTML = '';
    tc.style.display = 'flex';
    tc.style.gap = '24px';
    tc.style.alignItems = 'flex-start';
    const topGrid = el('div', 'top-grid');
    topGrid.style.flex = '1';

    // Featured row: 1 large left + 1 medium right
    const featRow = el('div', 'top-featured-row');
    const feat = D.HOME_TOP_ARTICLES[0];
    const featDiv = makeCardH(feat, { large: true, extraClass: 'top-featured fade-up', titleSize: '1.4rem' });
    featRow.appendChild(featDiv);
    const feat2 = D.HOME_TOP_ARTICLES[4];
    const feat2Div = makeCardH(feat2, { medium: true, extraClass: 'top-featured-secondary fade-up', titleSize: '1.15rem' });
    feat2Div.style.animationDelay = '.1s';
    const gcgBadge = el('a', 'cat-badge');
    gcgBadge.textContent = 'Góc nhìn chuyên gia';
    gcgBadge.href = '#category/goc-nhin-chuyen-gia';
    gcgBadge.addEventListener('click', e => { e.stopPropagation(); location.hash = '#category/goc-nhin-chuyen-gia'; });
    feat2Div.prepend(gcgBadge);
    featRow.appendChild(feat2Div);
    topGrid.appendChild(featRow);

    // 3 small (horizontal in 3 columns)
    const smallGrid = el('div', 'top-small-grid');
    D.HOME_TOP_ARTICLES.slice(1, 4).forEach((a, i) => {
      const card = makeCardH(a, { medium: true, extraClass: 'fade-up', titleSize: '1rem' });
      card.style.animationDelay = (i * .1 + .1) + 's';
      smallGrid.appendChild(card);
    });
    topGrid.appendChild(smallGrid);
    tc.appendChild(topGrid);

    // VN Map panel — bên phải cụm 5 bài top
    const tcVnPanel = document.createElement('div');
    tcVnPanel.style.cssText = 'width:288px;flex-shrink:0;';
    tcVnPanel.innerHTML = buildHomeSideBox('vn-map-box');
    tc.appendChild(tcVnPanel);
    initVnMapWeb('homeVnMapWrap');

    // Left column — 20 articles
    const hl = $('#homeLeft');
    hl.innerHTML = '';
    D.HOME_LEFT_ARTICLES.slice(0, 20).forEach(a => {
      const row = el('div', 'article-row');
      row.innerHTML = articleRowHTML(a);
      makeClickable(row, a);
      hl.appendChild(row);
    });

    // Right column — 5 featured clusters
    const hr = $('#homeRight');
    hr.innerHTML = '';
    D.FEATURED_CATEGORIES.forEach(catId => {
      const cat = D.CATEGORIES.find(c => c.id === catId);
      const articles = D.HOME_FEATURED[catId];
      const cluster = el('div', 'featured-cluster');

      // Section head
      const head = el('div', 'section-head');
      head.innerHTML = `<a href="#category/${cat.id}" class="sec-title">${cat.name}</a>
        <div class="sec-subs">${cat.subs.map(s =>
          `<a href="#category/${cat.id}/${s.id}" class="sec-sub">${s.name}</a>`
        ).join('')}</div>`;
      cluster.appendChild(head);

      // Row 2: 2 articles (left: horizontal card, right: title+sapo only)
      const row2 = el('div', 'fc-row2');
      const a1 = articles[0], a2 = articles[1];
      const card1 = makeCardH(a1, { medium: true, titleSize: '.95rem' });
      const card2 = el('div', 'title-only-card');
      card2.innerHTML = titleOnlyHTML(a2);
      makeClickable(card2, a2);
      row2.appendChild(card1);
      row2.appendChild(card2);
      cluster.appendChild(row2);

      // Row 3: 3 articles
      const row3 = el('div', 'fc-row3');
      articles.slice(2, 5).forEach(a => {
        const tc = el('div', 'title-only-card');
        tc.innerHTML = titleOnlyHTML(a);
        makeClickable(tc, a);
        row3.appendChild(tc);
      });
      cluster.appendChild(row3);

      hr.appendChild(cluster);

      // Insert interstitial box after this cluster if defined
      const interstitialType = FEATURED_INTERSTITIALS[catId];
      if (interstitialType) {
        const ibox = el('div', 'featured-interstitial');
        ibox.innerHTML = buildHomeSideBox(interstitialType);
        hr.appendChild(ibox);
      }
    });

    // Video cluster (trước remaining)
    const vc = $('#homeVideoCluster');
    vc.innerHTML = '';
    const vcHead = el('div', 'section-head');
    vcHead.innerHTML = `<a href="#category/video" class="sec-title">Video</a>
      <a href="#category/video" class="sec-sub" style="margin-left:auto;font-size:.82rem;color:var(--red)">Xem tất cả ›</a>`;
    vc.appendChild(vcHead);
    const strip = el('div', 'video-strip');
    const durations = ['2:34','4:12','1:58','3:07','5:20'];
    D.VIDEO_HOME_ARTICLES.forEach((a, i) => {
      const item = el('div', 'video-strip-item');
      item.innerHTML = `<div class="v-thumb-wrap">
        <img class="v-thumb" src="${a.avaUrl}" alt="" loading="lazy">
        <div class="v-play">&#9654;</div>
        <span class="v-duration">${durations[i]}</span>
      </div>
      <div class="v-title">${a.title}</div>`;
      item.addEventListener('click', () => location.hash = `#article/${a.id}`);
      strip.appendChild(item);
    });
    vc.appendChild(strip);

    // Remaining categories
    const rc = $('#remainingCats');
    rc.innerHTML = '';
    const remCats = D.CATEGORIES.filter(c => !D.FEATURED_CATEGORIES.includes(c.id) && c.id !== 'video');
    remCats.forEach(cat => {
      const articles = D.HOME_REMAINING[cat.id];
      if (!articles) return;
      const sideBoxType = HOME_SIDE_BOXES[cat.id];
      const div = el('div', sideBoxType ? 'remaining-cat rem-with-box' : 'remaining-cat');

      // Content goes into articlesCol (or div directly if no side box)
      const articlesCol = sideBoxType ? el('div', 'rem-articles-col') : div;

      const head = el('div', 'section-head');
      head.innerHTML = `<a href="#category/${cat.id}" class="sec-title">${cat.name}</a>
        <div class="sec-subs">${cat.subs.map(s =>
          `<a href="#category/${cat.id}/${s.id}" class="sec-sub">${s.name}</a>`
        ).join('')}</div>`;
      articlesCol.appendChild(head);

      // Featured article (horizontal)
      const featCard = makeCardH(articles[0], { medium: true, extraClass: 'rem-featured', titleSize: '1rem' });
      articlesCol.appendChild(featCard);

      // 2 title-only
      articles.slice(1, 3).forEach(a => {
        const tc2 = el('div', 'title-only-card');
        tc2.innerHTML = titleOnlyHTML(a);
        makeClickable(tc2, a);
        articlesCol.appendChild(tc2);
      });

      if (sideBoxType) {
        div.appendChild(articlesCol);
        const boxCol = el('div', 'rem-box-col');
        boxCol.innerHTML = buildHomeSideBox(sideBoxType);
        div.appendChild(boxCol);
      }

      rc.appendChild(div); // must be in DOM before calling init functions
      if (sideBoxType === 'war-map-compact') initWarMapMini('wmCompactSvgWrap');
      if (sideBoxType === 'vn-map-box') initVnMapWeb('homeVnMapWrap');
    });
  }

  // ============================================================
  // RENDER VIDEO FEED (trang mục Video — dark, snap-scroll)
  // ============================================================
  function renderVideoFeed() {
    $$('.page').forEach(p => p.classList.remove('active'));
    $('#page-category').classList.add('active');
    $('#catNormalContainer').style.display = 'none';
    const vfp = $('#videoFeedPage');
    vfp.classList.add('active');

    const feed = $('#vfFeed');
    feed.innerHTML = '';
    const articles = D.CATEGORY_ARTICLES['video'] || D.generateArticles('video', 10);
    const durations = ['2:34','4:12','1:58','3:07','5:20','6:45','3:15','2:50','7:00','4:38'];

    articles.forEach((a, i) => {
      const item = el('div', 'vf-item');
      item.innerHTML = `
        <div class="vf-thumb-wrap">
          <img class="vf-thumb" src="${a.avaUrl}" alt="" loading="lazy">
          <div class="vf-play-icon">&#9654;</div>
          <span class="vf-duration-badge">${durations[i % durations.length]}</span>
        </div>
        <div class="vf-info">
          <div class="vf-title">${a.title}</div>
          <div class="vf-meta">${a.time} · VTimes Video</div>
        </div>`;
      item.addEventListener('click', () => openVideoLightbox(articles, i));
      feed.appendChild(item);
    });

    // Bind lightbox close
    const lb = $('#videoLightbox');
    $('#vlbClose').onclick = () => lb.classList.remove('open');
    lb.addEventListener('click', e => { if (e.target === lb) lb.classList.remove('open'); });
  }

  function openVideoLightbox(articles, clickedIdx) {
    const carousel = $('#vlbCarousel');
    carousel.innerHTML = '';
    articles.forEach(a => {
      const slide = el('div', 'vlb-slide');
      slide.innerHTML = `<div class="vlb-thumb-wrap">
        <img class="vlb-thumb" src="${a.avaUrl}" alt="" loading="lazy">
        <div class="vlb-play">&#9654;</div>
      </div>
      <div class="vlb-title">${a.title}</div>`;
      carousel.appendChild(slide);
    });
    const lb = $('#videoLightbox');
    lb.classList.add('open');
    requestAnimationFrame(() => {
      carousel.scrollLeft = clickedIdx * carousel.clientWidth;
    });
  }

  // ============================================================
  // RENDER CATEGORY PAGE
  // ============================================================
  function renderComingSoon(catId, subId) {
    $('#videoFeedPage').classList.remove('active');
    $('#catNormalContainer').style.display = '';
    const cat = D.CATEGORIES.find(c => c.id === catId);
    // Show subcategory bar
    const subBar = $('#webCatSubsBar');
    subBar.style.display = 'block';
    subBar.innerHTML = cat ? `<div class="web-cat-subs-inner">${
      cat.subs.map(s =>
        `<a href="#category/${catId}/${s.id}" class="web-cat-sub-link${subId === s.id ? ' active' : ''}">${s.name}</a>`
      ).join('')
    }</div>` : '';
    // Clear all sections
    ['catSpecial','catTopCluster','catLeft','catRight','catStream'].forEach(id => { $('#' + id).innerHTML = ''; });
    // Show coming soon in stream container
    const stream = $('#catStream');
    stream.innerHTML = `<div class="coming-soon-wrap">
      <div class="coming-soon-icon">🚧</div>
      <div class="coming-soon-title">Đang phát triển</div>
      <div class="coming-soon-sub">Tính năng này đang được xây dựng. Vui lòng quay lại sau!</div>
    </div>`;
  }

  // ============================================================
  // GÓC CHUYÊN GIA PAGE
  // ============================================================
  function renderGCGPage() {
    $('#videoFeedPage').classList.remove('active');
    $('#catNormalContainer').style.display = '';
    $$('.nav-cat-link').forEach(l => l.classList.toggle('active', l.dataset.cat === 'goc-nhin-chuyen-gia'));
    $('#webCatSubsBar').style.display = 'none';
    ['catSpecial','catTopCluster','catLeft','catRight'].forEach(id => { $('#'+id).innerHTML = ''; });

    const stream = $('#catStream');
    stream.innerHTML = '';
    const articles = D.CATEGORY_ARTICLES['goc-nhin-chuyen-gia'] || [];
    if (!articles.length) return;

    const wrap = el('div', 'gcg-wrap');

    // Main list — 12 bài
    const list = el('div', 'gcg-list');
    articles.slice(0, 12).forEach(a => {
      const item = el('div', 'gcg-article fade-up');
      const avatarSeed = 'author' + a.id;
      item.innerHTML = `
        <div class="gcg-body">
          <div class="gcg-title">${a.title}</div>
          <div class="gcg-sapo">${a.sapo}</div>
        </div>
        <div class="gcg-avatar-wrap">
          <img class="gcg-avatar" src="https://picsum.photos/seed/${avatarSeed}/80/80" alt="${a.author}" loading="lazy">
          <div class="gcg-author">${a.author}</div>
        </div>`;
      item.querySelector('.gcg-title').addEventListener('click', () => goArticle(a));
      item.querySelector('.gcg-avatar').addEventListener('click', () => goArticle(a));
      list.appendChild(item);
    });
    wrap.appendChild(list);

    // Sidebar — 6 bài tiếp
    const sidebar = el('div', 'gcg-sidebar');
    const sHead = el('div', 'gcg-sidebar-head');
    sHead.textContent = 'Đọc nhiều nhất';
    sidebar.appendChild(sHead);
    articles.slice(12, 18).forEach(a => {
      const item = el('div', 'gcg-sidebar-item');
      item.innerHTML = `
        <img class="gcg-sidebar-ava" src="${a.avaUrl}" alt="" loading="lazy">
        <div class="gcg-sidebar-body">
          <div class="gcg-sidebar-title">${a.title}</div>
          <div class="gcg-sidebar-author">${a.author}</div>
        </div>`;
      item.querySelector('.gcg-sidebar-title').addEventListener('click', () => goArticle(a));
      item.querySelector('.gcg-sidebar-ava').addEventListener('click', () => goArticle(a));
      sidebar.appendChild(item);
    });
    wrap.appendChild(sidebar);
    stream.appendChild(wrap);
  }

  function renderCategory(catId, subId) {
    const cat = D.CATEGORIES.find(c => c.id === catId);
    if (!cat) return;

    // Góc chuyên gia — custom opinion layout
    if (catId === 'goc-nhin-chuyen-gia') { renderGCGPage(); return; }

    // Check comingSoon on top-level category
    if (cat.comingSoon) { renderComingSoon(catId, null); return; }

    // Check comingSoon on sub
    if (subId) {
      const sub = cat.subs.find(s => s.id === subId);
      if (sub && sub.comingSoon) { renderComingSoon(catId, subId); return; }
    }

    // Video: special dark feed
    if (catId === 'video') { renderVideoFeed(); return; }

    // Hide video feed, show normal container
    $('#videoFeedPage').classList.remove('active');
    $('#catNormalContainer').style.display = '';

    // highlight nav
    $$('.nav-cat-link').forEach(l => l.classList.toggle('active', l.dataset.cat === catId));

    // Subcategory bar below nav
    const subBar = $('#webCatSubsBar');
    subBar.style.display = 'block';
    subBar.innerHTML = `<div class="web-cat-subs-inner">${
      cat.subs.map(sub =>
        `<a href="#category/${catId}/${sub.id}" class="web-cat-sub-link${subId === sub.id ? ' active' : ''}">${sub.name}</a>`
      ).join('')
    }</div>`;

    // Special box
    const specialContainer = $('#catSpecial');
    specialContainer.innerHTML = '';
    if (catId === 'the-gioi' && !subId) {
      specialContainer.innerHTML = buildWarMapWidget();
      initWarMap();
      setTimeout(() => { if (window.pmReinit) window.pmReinit(); }, 200);
    } else if (subId) {
      const sub = cat.subs.find(s => s.id === subId);
      if (sub && sub.special && sub.special !== 'war-map') {
        specialContainer.innerHTML = buildSpecialBox(sub);
        setTimeout(() => { if (window.pmReinit) window.pmReinit(); }, 100);
      }
    }

    // Top cluster
    const articles = D.CATEGORY_ARTICLES[catId] || D.generateArticles(catId, 20);
    const topC = $('#catTopCluster');
    topC.innerHTML = '';

    if (catId === 'thoi-su' && !subId) {
      // Two-column: articles left + VN map right
      const withMap = el('div', 'cat-top-with-map');

      const artCol = el('div', 'cat-top-articles-col');
      const featDiv = makeCardH(articles[0], { large: true, extraClass: 'cat-top-featured fade-up', titleSize: '1.4rem' });
      artCol.appendChild(featDiv);
      const smallGrid = el('div', 'cat-top-small');
      articles.slice(1, 4).forEach((a, i) => {
        const card = makeCardH(a, { medium: true, extraClass: 'fade-up', titleSize: '.95rem' });
        card.style.animationDelay = (i * .08 + .1) + 's';
        smallGrid.appendChild(card);
      });
      artCol.appendChild(smallGrid);
      withMap.appendChild(artCol);

      const mapCol = el('div', 'cat-top-map-col');
      mapCol.innerHTML = `<div class="cat-special-box" data-present="vn-map">
        <h3>🇻🇳 Tin nóng — Bản đồ Việt Nam</h3>
        <div class="vn-map-web-wrap" id="catVnMapWrap">
          <div class="wm-loading"><div class="wm-loading-spinner"></div><span>Đang tải bản đồ...</span></div>
        </div>
        <div class="vn-map-legend">
          <span class="vn-legend-dot"></span>
          <span class="vn-legend-text">Nhấn vào chấm đỏ để xem chuỗi tin tức</span>
        </div></div>`;
      withMap.appendChild(mapCol);
      topC.appendChild(withMap);
      setTimeout(() => initVnMapWeb('catVnMapWrap'), 0);
      setTimeout(() => { if (window.pmReinit) window.pmReinit(); }, 200);
    } else {
      const featDiv = makeCardH(articles[0], { large: true, extraClass: 'cat-top-featured fade-up', titleSize: '1.4rem' });
      topC.appendChild(featDiv);
      const smallGrid = el('div', 'cat-top-small');
      articles.slice(1, 4).forEach((a, i) => {
        const card = makeCardH(a, { medium: true, extraClass: 'fade-up', titleSize: '.95rem' });
        card.style.animationDelay = (i * .08 + .1) + 's';
        smallGrid.appendChild(card);
      });
      topC.appendChild(smallGrid);
    }

    // Left: 10 articles
    const catLeft = $('#catLeft');
    catLeft.innerHTML = '';
    articles.slice(4, 14).forEach(a => {
      const row = el('div', 'article-row');
      row.innerHTML = articleRowHTML(a);
      makeClickable(row, a);
      catLeft.appendChild(row);
    });

    // Right: sub-category clusters
    const catRight = $('#catRight');
    catRight.innerHTML = '';
    cat.subs.forEach(sub => {
      const subArts = D.generateArticles(catId, 3, sub.id);
      const cluster = el('div', 'sub-cluster');

      const head = el('div', 'section-head');
      head.innerHTML = `<a href="#category/${catId}/${sub.id}" class="sec-title">${sub.name}</a>`;
      cluster.appendChild(head);

      const grid = el('div', 'sub-cluster-grid');
      // left: 1 article (horizontal)
      const c1 = makeCardH(subArts[0], { medium: true, titleSize: '.9rem' });
      grid.appendChild(c1);

      // right: 2 title-only
      const rightCol = el('div');
      subArts.slice(1, 3).forEach(a => {
        const tc3 = el('div', 'title-only-card');
        tc3.innerHTML = titleOnlyHTML(a);
        makeClickable(tc3, a);
        rightCol.appendChild(tc3);
      });
      grid.appendChild(rightCol);
      cluster.appendChild(grid);
      catRight.appendChild(cluster);
    });

    // Stream remaining
    const stream = $('#catStream');
    stream.innerHTML = '';
    articles.slice(14).forEach(a => {
      const row = el('div', 'article-row');
      row.innerHTML = articleRowHTML(a);
      makeClickable(row, a);
      stream.appendChild(row);
    });
    const moreWrap = el('div', '');
    moreWrap.style.cssText = 'text-align:center;padding:16px 0 24px;';
    moreWrap.innerHTML = `<button class="btn-more">Xem thêm bài viết ›</button>`;
    stream.appendChild(moreWrap);
  }

  // ============================================================
  // HOME PAGE SIDE BOX MAPPING
  // ============================================================
  const HOME_SIDE_BOXES = {
    'thoi-su':        'weather-box',
    'the-gioi':       'war-map-compact',
    'the-thao':       'match-schedule',
    'phap-luat':      'law-search',
    'giao-duc':       'exam-search',
    'giai-tri':       'lunar-calendar',
  };

  // Featured interstitials: which box appears below each featured cluster
  const FEATURED_INTERSTITIALS = {
    'kinh-te':          'stock-search',
    'nha-dat':          'project-search',
    'xe-cong-nghe':     'thietbi-search',
    'doi-song-du-lich': 'destination-search',
    'suc-khoe':         'disease-search',
  };

  // ============================================================
  // WAR MAP — SHARED DATA & HELPERS (used by full map + mini map)
  // ============================================================
  let _wmCache = null;
  async function loadWorldAtlas() {
    if (_wmCache) return _wmCache;
    if (!window.topojson) {
      await new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/topojson-client@3.1.0/dist/topojson-client.min.js';
        s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
      });
    }
    const world = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json').then(r => r.json());
    _wmCache = window.topojson.feature(world, world.objects.countries);
    return _wmCache;
  }

  const WAR_CONFLICTS_META = {
    'ukraine-russia':   { label: 'Chiến tranh Ukraine — Nga', catId: 'the-gioi', color: '#FF7043' },
    'israel-palestine': { label: 'Xung đột Israel — Gaza',    catId: 'the-gioi', color: '#29B6F6' },
    'usa-iran':         { label: 'Căng thẳng Mỹ — Iran',      catId: 'the-gioi', color: '#AB47BC' },
  };

  // ISO 3166-1 numeric codes
  const WAR_COUNTRY_MAP = {
    '804': { conflictKey: 'ukraine-russia',   color: '#FF7043', name: 'Ukraine' },
    '643': { conflictKey: 'ukraine-russia',   color: '#FF8A65', name: 'Nga' },
    '376': { conflictKey: 'israel-palestine', color: '#29B6F6', name: 'Israel' },
    '275': { conflictKey: 'israel-palestine', color: '#4FC3F7', name: 'Palestine' },
    '840': { conflictKey: 'usa-iran',         color: '#AB47BC', name: 'Mỹ' },
    '364': { conflictKey: 'usa-iran',         color: '#CE93D8', name: 'Iran' },
  };

  const WAR_PULSES = [
    { lon: 37.0, lat: 48.5, color: '#E64A19', r: 5,   dur: '2s'   }, // Donbas
    { lon: 34.3, lat: 31.5, color: '#0288D1', r: 3.8, dur: '2.3s' }, // Gaza
    { lon: 53.5, lat: 32.5, color: '#8E24AA', r: 4,   dur: '2.6s' }, // Gulf/Iran
  ];

  function wmProject(lon, lat, W, H) {
    const x = (lon + 180) / 360 * W;
    const y = (73 - Math.max(-55, Math.min(73, lat))) / 128 * H;
    return [x, y];
  }
  function wmRingPath(ring, W, H) {
    if (ring.length < 2) return '';
    let d = '';
    for (let i = 0; i < ring.length; i++) {
      const [x, y] = wmProject(ring[i][0], ring[i][1], W, H);
      if (i === 0) {
        d += 'M' + x.toFixed(1) + ',' + y.toFixed(1);
      } else {
        const dLon = Math.abs(ring[i][0] - ring[i-1][0]);
        d += (dLon > 180 ? 'M' : 'L') + x.toFixed(1) + ',' + y.toFixed(1);
      }
    }
    return d + 'Z';
  }
  function wmFeaturePath(feature, W, H) {
    const g = feature.geometry;
    if (!g) return '';
    const polys = g.type === 'Polygon' ? [g.coordinates] : g.coordinates;
    return polys.map(poly => poly.map(ring => wmRingPath(ring, W, H)).join('')).join('');
  }
  function buildConflictMapSVG(countries, W, H, withPulses) {
    const sorted = [...countries.features].sort((a, b) =>
      (WAR_COUNTRY_MAP[String(a.id)] ? 1 : 0) - (WAR_COUNTRY_MAP[String(b.id)] ? 1 : 0)
    );
    let paths = '';
    sorted.forEach(f => {
      const id = String(f.id);
      const conf = WAR_COUNTRY_MAP[id];
      const d = wmFeaturePath(f, W, H);
      if (!d) return;
      if (conf) {
        paths += `<path d="${d}" fill="${conf.color}" fill-opacity="0.82" stroke="#fff" stroke-width="0.8" class="wm-country" data-id="${id}" data-conflict="${conf.conflictKey}" data-cname="${conf.name}"/>`;
      } else {
        paths += `<path d="${d}" fill="#ddd8c2" stroke="#bfbba8" stroke-width="0.3"/>`;
      }
    });
    let dots = '';
    if (withPulses) {
      WAR_PULSES.forEach(p => {
        const [x, y] = wmProject(p.lon, p.lat, W, H);
        dots += `<circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="${p.r}" fill="${p.color}" opacity="0.2">
          <animate attributeName="r" values="${p.r};${(p.r*2.2).toFixed(1)};${p.r}" dur="${p.dur}" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0.2;0;0.2" dur="${p.dur}" repeatCount="indefinite"/>
        </circle>
        <circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="${(p.r*0.55).toFixed(1)}" fill="${p.color}" opacity="0.9"/>`;
      });
    }
    return `<svg viewBox="0 0 ${W} ${H}" class="wm-svg" xmlns="http://www.w3.org/2000/svg">
      <rect width="${W}" height="${H}" fill="#b8d4e8"/>
      <g>${paths}</g><g>${dots}</g>
    </svg>`;
  }

  // Mini map: renders into any container, click → go to full war map
  async function initWarMapMini(wrapperId) {
    const wrap = document.getElementById(wrapperId);
    if (!wrap) return;
    try {
      const countries = await loadWorldAtlas();
      wrap.innerHTML = buildConflictMapSVG(countries, 400, 200, false);
      const svg = wrap.querySelector('svg');
      if (svg) { svg.style.cursor = 'pointer'; svg.addEventListener('click', () => { location.hash = '#category/the-gioi/quan-su'; }); }
    } catch(e) {
      wrap.innerHTML = `<div class="wm-load-error">⚠ Lỗi tải bản đồ</div>`;
    }
  }

  // ============================================================
  // FULL WAR MAP WIDGET (category page)
  // ============================================================
  function buildWarMapWidget() {
    return `<div class="war-map-full">
      <div class="wm-full-header">
        <h3>🌍 Bản đồ Chiến sự Thế giới</h3>
        <span class="wm-full-subtitle">Cập nhật 27/02/2026 · Hover để xem, click để đọc tin</span>
      </div>
      <div class="wm-svg-wrap" id="wmSvgWrap">
        <div class="wm-loading"><div class="wm-loading-spinner"></div><span>Đang tải bản đồ...</span></div>
      </div>
      <div class="wm-legend">
        <div class="wm-legend-item" data-conflict="ukraine-russia">
          <div class="wm-legend-color" style="background:#FF7043"></div>
          <div class="wm-legend-texts">
            <div class="wm-conflict-name">⚔ Chiến tranh Ukraine — Nga</div>
            <div class="wm-conflict-date">Từ tháng 2/2022 · Đông Âu</div>
          </div><span class="wm-legend-arr">›</span>
        </div>
        <div class="wm-legend-item" data-conflict="israel-palestine">
          <div class="wm-legend-color" style="background:#29B6F6"></div>
          <div class="wm-legend-texts">
            <div class="wm-conflict-name">⚔ Xung đột Israel — Gaza</div>
            <div class="wm-conflict-date">Từ tháng 10/2023 · Trung Đông</div>
          </div><span class="wm-legend-arr">›</span>
        </div>
        <div class="wm-legend-item" data-conflict="usa-iran">
          <div class="wm-legend-color" style="background:#AB47BC"></div>
          <div class="wm-legend-texts">
            <div class="wm-conflict-name">⚔ Căng thẳng Mỹ — Iran</div>
            <div class="wm-conflict-date">Vùng Vịnh · Trung Đông</div>
          </div><span class="wm-legend-arr">›</span>
        </div>
      </div>
      <div class="wm-articles-panel" id="wmArticlesPanel" style="display:none">
        <h4 id="wmArticlesTitle"></h4>
        <div id="wmArticlesList"></div>
      </div>
    </div>`;
  }

  async function initWarMap() {
    const wrap = document.getElementById('wmSvgWrap');
    const panel = document.getElementById('wmArticlesPanel');
    const panelTitle = document.getElementById('wmArticlesTitle');
    const panelList = document.getElementById('wmArticlesList');
    if (!wrap) return;

    function showConflictArticles(conflictKey) {
      const c = WAR_CONFLICTS_META[conflictKey];
      if (!c || !panel) return;
      const arts = D.generateArticles(c.catId, 5);
      panelTitle.textContent = c.label;
      panelList.innerHTML = arts.map(a =>
        `<div class="wm-art-item" onclick="location.hash='#article/${a.id}'">
          <div class="wm-art-title">${a.title}</div>
          <div class="wm-art-time">${a.time}</div>
        </div>`
      ).join('');
      const alreadySame = panelTitle.dataset.current === conflictKey;
      panel.style.display = (panel.style.display !== 'none' && alreadySame) ? 'none' : 'block';
      panelTitle.dataset.current = conflictKey;
    }

    let countries;
    try { countries = await loadWorldAtlas(); }
    catch(e) { wrap.innerHTML = `<div class="wm-load-error">⚠ Không thể tải bản đồ. Vui lòng kiểm tra kết nối mạng.</div>`; return; }

    const W = 960, H = 480;
    const tooltipEl = document.createElement('div');
    tooltipEl.className = 'wm-tooltip'; tooltipEl.id = 'wmTooltip';

    wrap.innerHTML = buildConflictMapSVG(countries, W, H, true);
    wrap.appendChild(tooltipEl);

    wrap.querySelectorAll('.wm-country').forEach(country => {
      country.addEventListener('mouseenter', () => {
        const conf = WAR_CONFLICTS_META[country.dataset.conflict];
        tooltipEl.textContent = conf ? `${country.dataset.cname} · ${conf.label}` : country.dataset.cname;
        tooltipEl.style.display = 'block';
      });
      country.addEventListener('mousemove', e => {
        const rect = wrap.getBoundingClientRect();
        tooltipEl.style.left = (e.clientX - rect.left + 12) + 'px';
        tooltipEl.style.top  = (e.clientY - rect.top  - 32) + 'px';
      });
      country.addEventListener('mouseleave', () => { tooltipEl.style.display = 'none'; });
      country.addEventListener('click', e => { e.stopPropagation(); showConflictArticles(country.dataset.conflict); });
    });
    document.querySelectorAll('.wm-legend-item').forEach(item => {
      item.addEventListener('click', () => showConflictArticles(item.dataset.conflict));
    });
  }

  // ============================================================
  // VN NEWS MAP — WEB
  // ============================================================
  const VN_EVENT_DATA = [
    {
      id: 'e1', province: 'Hà Nội', lat: 21.028, lon: 105.834,
      label: '🔴 Cháy lớn tại Hà Nội',
      articles: [
        { time: '16:00 01/03', title: 'Đã khống chế được đám cháy, điều tra nguyên nhân', avaUrl: 'https://picsum.photos/seed/fire1/90/68' },
        { time: '15:30 01/03', title: 'Người dân sơ tán khẩn cấp, khu vực bị phong tỏa 200m' },
        { time: '15:10 01/03', title: 'Lực lượng PCCC Hà Nội điều 8 xe chữa cháy đến hiện trường' },
        { time: '14:45 01/03', title: 'Thương vong vụ cháy: 2 người bị bỏng nặng được đưa vào viện' },
        { time: '14:32 01/03', title: 'Cháy chung cư mini tại phường Trương Định, 3 người mắc kẹt' }
      ]
    },
    {
      id: 'e2', province: 'TP. Hồ Chí Minh', lat: 10.762, lon: 106.660,
      label: '🔴 Tai nạn TP.HCM',
      articles: [
        { time: '10:30 01/03', title: 'Toàn bộ 5 nạn nhân đã qua cơn nguy kịch, 1 người cần phẫu thuật', avaUrl: 'https://picsum.photos/seed/acc1/90/68' },
        { time: '10:10 01/03', title: 'Tài xế xe tải bị tạm giữ, nồng độ cồn vượt ngưỡng cho phép' },
        { time: '09:45 01/03', title: 'Cảnh sát giao thông triển khai phân luồng, hướng dẫn phương tiện' },
        { time: '09:28 01/03', title: 'Giao thông ùn tắc nghiêm trọng đoạn Điện Biên Phủ — Hai Bà Trưng' },
        { time: '09:15 01/03', title: 'Xe tải húc hàng loạt xe máy trên đường Điện Biên Phủ, 5 người nhập viện' }
      ]
    },
    {
      id: 'e3', province: 'Đà Nẵng', lat: 16.068, lon: 108.212,
      label: '🔴 Bão số 3 đổ bộ Đà Nẵng',
      articles: [
        { time: '10:15 01/03', title: 'Bão suy yếu thành áp thấp nhiệt đới khi vào đến Tây Nguyên', avaUrl: 'https://picsum.photos/seed/storm1/90/68' },
        { time: '09:00 01/03', title: 'Lũ quét xuất hiện ở vùng núi Hòa Vang, di dời 200 hộ dân' },
        { time: '08:20 01/03', title: 'Đà Nẵng cho học sinh nghỉ học, dừng hoạt động dịch vụ không thiết yếu' },
        { time: '07:45 01/03', title: 'Hàng nghìn hộ dân mất điện, nhiều tuyến đường bị cây ngã đổ' },
        { time: '07:00 01/03', title: 'Bão số 3 đổ bộ vào Đà Nẵng — Quảng Nam, gió giật cấp 11' }
      ]
    },
    {
      id: 'e4', province: 'Cần Thơ', lat: 10.045, lon: 105.748,
      label: '🔴 Cháy kho — Cần Thơ',
      articles: [
        { time: '13:10 01/03', title: 'Công an Cần Thơ lấy lời khai bảo vệ kho, truy tìm nguyên nhân', avaUrl: 'https://picsum.photos/seed/fire2/90/68' },
        { time: '12:30 01/03', title: 'Không có thương vong về người, 3 lính cứu hỏa bị ngạt khói' },
        { time: '12:00 01/03', title: 'Thiệt hại ước tính hàng tỷ đồng, toàn bộ hàng hóa bị thiêu rụi' },
        { time: '11:35 01/03', title: 'Lửa lan sang kho lân cận, khói đen bao phủ khu vực rộng lớn' },
        { time: '11:20 01/03', title: 'Cháy kho hàng rộng 2.000m² tại khu công nghiệp Trà Nóc, Cần Thơ' }
      ]
    },
    {
      id: 'e5', province: 'Quảng Ninh', lat: 21.006, lon: 107.292,
      label: '🔴 Sập hầm lò — Quảng Ninh',
      articles: [
        { time: '10:00 01/03', title: 'Tạm đình chỉ hoạt động mỏ than, chờ điều tra nguyên nhân sự cố', avaUrl: 'https://picsum.photos/seed/mine1/90/68' },
        { time: '09:30 01/03', title: 'Cả 4 công nhân được đưa ra khỏi hầm, đang được cấp cứu khẩn cấp' },
        { time: '08:00 01/03', title: 'Đã giải cứu được 2 công nhân, 2 người còn lại chưa có tín hiệu' },
        { time: '07:15 01/03', title: 'Triển khai lực lượng giải cứu, máy móc đào đường hầm tiếp cận' },
        { time: '06:30 01/03', title: 'Sập hầm lò khai thác than tại Công ty Than Mạo Khê, 4 công nhân bị nạn' }
      ]
    },
    {
      id: 'e6', province: 'Nghệ An', lat: 18.672, lon: 105.692,
      label: '🔴 Triệt phá ma túy lớn',
      articles: [
        { time: '10:00 01/03', title: 'Cục Cảnh sát điều tra tội phạm về ma túy vào cuộc điều tra mở rộng', avaUrl: 'https://picsum.photos/seed/sec1/90/68' },
        { time: '09:00 01/03', title: 'Mạng lưới vận chuyển ma túy qua biên giới Việt — Lào bị triệt phá' },
        { time: '08:00 01/03', title: 'Công an Nghệ An khởi tố vụ án, tạm giam toàn bộ 12 đối tượng' },
        { time: '22:30 29/02', title: 'Thu giữ 30kg ma túy tổng hợp, 2 khẩu súng và nhiều vũ khí nóng' },
        { time: '22:00 29/02', title: 'Triệt phá đường dây ma túy lớn tại Nghệ An, bắt 12 đối tượng' }
      ]
    }
  ];

  const VN_REGION_COUNTRIES = new Set(['704','418','116','156','764','104','458']);

  function vnMapProject(lon, lat, W, H) {
    const minLon = 98, maxLon = 116, minLat = 4, maxLat = 28;
    const x = (lon - minLon) / (maxLon - minLon) * W;
    const y = (maxLat - lat) / (maxLat - minLat) * H;
    return [x, y];
  }

  function buildVnMapSVG(countries, W, H) {
    let paths = '';
    countries.features.forEach(f => {
      const id = String(f.id);
      if (!VN_REGION_COUNTRIES.has(id)) return;
      const isVN = id === '704';
      const g = f.geometry;
      if (!g) return;
      const polys = g.type === 'Polygon' ? [g.coordinates] : g.coordinates;
      let d = '';
      polys.forEach(poly => {
        poly.forEach(ring => {
          if (ring.length < 2) return;
          for (let i = 0; i < ring.length; i++) {
            const [x, y] = vnMapProject(ring[i][0], ring[i][1], W, H);
            if (i === 0) d += 'M' + x.toFixed(1) + ',' + y.toFixed(1);
            else {
              const dLon = Math.abs(ring[i][0] - ring[i-1][0]);
              d += (dLon > 90 ? 'M' : 'L') + x.toFixed(1) + ',' + y.toFixed(1);
            }
          }
          d += 'Z';
        });
      });
      if (!d) return;
      paths += isVN
        ? `<path d="${d}" fill="#c8ddf5" stroke="#7aaad8" stroke-width="0.6"/>`
        : `<path d="${d}" fill="#e2ebf5" stroke="#b8c8d8" stroke-width="0.4"/>`;
    });
    let dots = '';
    VN_EVENT_DATA.forEach((ev, i) => {
      const [cx, cy] = vnMapProject(ev.lon, ev.lat, W, H);
      const delay = (i * 0.4).toFixed(1);
      dots += `<g class="vn-map-event-dot" data-evid="${ev.id}" transform="translate(${cx.toFixed(1)},${cy.toFixed(1)})">
        <circle class="vn-pulse-ring" cx="0" cy="0" r="6" style="animation-delay:${delay}s"/>
        <circle class="vn-dot-center" cx="0" cy="0" r="4"/>
      </g>`;
    });
    return `<svg viewBox="0 0 ${W} ${H}" style="width:100%;display:block" xmlns="http://www.w3.org/2000/svg">
      <rect width="${W}" height="${H}" fill="#b8d4e8"/>
      <g>${paths}</g>
      <g>${dots}</g>
    </svg>`;
  }

  async function initVnMapWeb(wrapperId) {
    const wrap = document.getElementById(wrapperId);
    if (!wrap) return;
    try {
      const countries = await loadWorldAtlas();
      wrap.innerHTML = buildVnMapSVG(countries, 300, 380);
      wrap.querySelectorAll('.vn-map-event-dot').forEach(dot => {
        dot.addEventListener('click', e => {
          e.stopPropagation();
          const ev = VN_EVENT_DATA.find(x => x.id === dot.dataset.evid);
          if (ev) showVnEventPanel(ev);
        });
      });
    } catch(e) {
      wrap.innerHTML = `<div style="padding:16px;color:#999;font-size:.8rem;text-align:center">⚠ Lỗi tải bản đồ</div>`;
    }
  }

  function showVnEventPanel(ev) {
    let overlay = document.getElementById('vnEventOverlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'vnEventOverlay';
      overlay.className = 'vn-event-overlay';
      document.body.appendChild(overlay);
      overlay.addEventListener('click', e => { if (e.target === overlay) closeVnEventPanel(); });
    }
    let panel = overlay.querySelector('.vn-event-panel');
    if (!panel) {
      panel = document.createElement('div');
      panel.className = 'vn-event-panel';
      overlay.appendChild(panel);
    }
    const [top, ...rest] = ev.articles;
    const restHtml = rest.map(a => `
      <div class="vn-ep-list-item" onclick="location.hash='#category/thoi-su';closeVnEventPanel()">
        <div class="vn-ep-list-time">${a.time}</div>
        <div class="vn-ep-list-title">${a.title}</div>
      </div>`).join('');
    panel.innerHTML = `
      <div class="vn-ep-header">
        <div class="vn-ep-title">${ev.label}</div>
        <button class="vn-ep-close" onclick="closeVnEventPanel()">✕</button>
      </div>
      <div class="vn-ep-location">📍 ${ev.province}</div>
      <div>
        <div class="vn-ep-top-article" onclick="location.hash='#category/thoi-su';closeVnEventPanel()">
          ${top.avaUrl ? `<img class="vn-ep-top-img" src="${top.avaUrl}" alt="" loading="lazy">` : ''}
          <div class="vn-ep-top-body">
            <div class="vn-ep-top-badge">MỚI NHẤT</div>
            <div class="vn-ep-top-time">${top.time}</div>
            <div class="vn-ep-top-title">${top.title}</div>
          </div>
        </div>
        ${restHtml}
        <div><a href="#category/thoi-su" class="vn-ep-see-more" onclick="closeVnEventPanel()">Xem toàn bộ tin Thời sự →</a></div>
      </div>`;
    overlay.classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  window.closeVnEventPanel = function() {
    const overlay = document.getElementById('vnEventOverlay');
    if (overlay) overlay.classList.remove('open');
    document.body.style.overflow = '';
  };

  // ============================================================
  // HOME PAGE SIDE BOX BUILDER
  // ============================================================
  function buildHomeSideBox(type) {
    switch(type) {
      case 'weather-box': return `<div class="cat-special-box">
        <h3>🌤 Thời tiết hôm nay</h3>
        <div class="weather-cities">
          <div class="weather-city"><span class="w-city-name">Hà Nội</span><span class="w-icon">⛅</span><span class="w-temp">24°C</span><span class="w-desc">Có mây</span></div>
          <div class="weather-city"><span class="w-city-name">TP.HCM</span><span class="w-icon">☀️</span><span class="w-temp">33°C</span><span class="w-desc">Nắng đẹp</span></div>
          <div class="weather-city"><span class="w-city-name">Đà Nẵng</span><span class="w-icon">🌦</span><span class="w-temp">27°C</span><span class="w-desc">Mưa nhẹ</span></div>
          <div class="weather-city"><span class="w-city-name">Đà Lạt</span><span class="w-icon">🌧</span><span class="w-temp">18°C</span><span class="w-desc">Mưa vừa</span></div>
          <div class="weather-city"><span class="w-city-name">Cần Thơ</span><span class="w-icon">🌤</span><span class="w-temp">32°C</span><span class="w-desc">Nắng nhẹ</span></div>
        </div></div>`;
      case 'war-map-compact': return `<div class="cat-special-box">
        <h3>🌍 Bản đồ Chiến sự</h3>
        <div class="wm-mini-wrap" id="wmCompactSvgWrap">
          <div class="wm-loading"><div class="wm-loading-spinner"></div><span>Đang tải...</span></div>
        </div>
        <div class="wm-mini-legend">
          <div class="wm-mini-conflict"><span class="wm-mini-dot" style="background:#FF7043"></span>Chiến tranh Ukraine — Nga</div>
          <div class="wm-mini-conflict"><span class="wm-mini-dot" style="background:#29B6F6"></span>Xung đột Israel — Gaza</div>
          <div class="wm-mini-conflict"><span class="wm-mini-dot" style="background:#AB47BC"></span>Căng thẳng Mỹ — Iran</div>
        </div>
        <a href="#category/the-gioi/quan-su" class="war-map-more-link">Xem bản đồ đầy đủ →</a>
        </div>`;
      case 'traffic-fine': return `<div class="cat-special-box">
        <h3>🚗 Tra cứu phạt nguội</h3>
        <div class="search-row">
          <input type="text" placeholder="Nhập biển số xe (VD: 30A-12345)">
          <button class="search-btn">Tra cứu</button>
        </div></div>`;
      case 'match-schedule': {
        const matches = D.MATCH_SCHEDULE;
        const doubled = [...matches, ...matches];
        const items = doubled.map(m =>
          `<span class="match-item"><span class="match-time">${m.time}</span> ${m.home} <span class="match-vs">vs</span> ${m.away}</span>`
        ).join('');
        return `<div class="match-schedule-box">
          <div class="match-box-header">
            <span class="match-box-title">⚽ Lịch thi đấu</span>
            <a href="#category/the-thao/lich-thi-dau" class="match-box-more">Xem thêm →</a>
          </div>
          <div class="match-ticker-wrap"><div class="match-ticker-inner">${items}</div></div>
        </div>`;
      }
      case 'quote-box': {
        const quotes = D.FAMOUS_QUOTES;
        const q = quotes[Math.floor(Math.random() * quotes.length)];
        const photoSeed = encodeURIComponent(q.author);
        return `<div class="quote-box">
          <div class="quote-photo-wrap">
            <img src="https://picsum.photos/seed/${photoSeed}/320/130" alt="${q.author}" class="quote-photo" loading="lazy">
          </div>
          <div class="quote-body">
            <div class="quote-text">${q.quote}</div>
            <div class="quote-author">— ${q.author}</div>
          </div>
        </div>`;
      }
      case 'vn-map-box': return `<div class="cat-special-box">
        <h3>🇻🇳 Tin nóng — Bản đồ Việt Nam</h3>
        <div class="vn-map-web-wrap" id="homeVnMapWrap">
          <div class="wm-loading"><div class="wm-loading-spinner"></div><span>Đang tải bản đồ...</span></div>
        </div>
        <div class="vn-map-legend">
          <span class="vn-legend-dot"></span>
          <span class="vn-legend-text">Nhấn vào chấm đỏ để xem chuỗi tin tức</span>
        </div></div>`;
      case 'lunar-calendar': return buildLunarCalBox();
      default: return buildSpecialBox({ special: type });
    }
  }

  function buildLunarCalBox() {
    const now = new Date();
    const y = now.getFullYear(), mo = now.getMonth(), d = now.getDate();
    const DOW = ['Chủ Nhật','Thứ Hai','Thứ Ba','Thứ Tư','Thứ Năm','Thứ Sáu','Thứ Bảy'];
    const MON = ['Tháng 1','Tháng 2','Tháng 3','Tháng 4','Tháng 5','Tháng 6','Tháng 7','Tháng 8','Tháng 9','Tháng 10','Tháng 11','Tháng 12'];
    const firstDow = new Date(y, mo, 1).getDay();
    const daysInMo = new Date(y, mo + 1, 0).getDate();
    // Âm lịch (demo — hardcoded offset từ năm Bính Ngọ 2026)
    const lunarOffset = 13; // ngày 13 tháng Giêng khi d=1 tháng 3 2026
    const lunarDay = ((d - 1 + lunarOffset - 1) % 30) + 1;
    let cells = '';
    for (let i = 0; i < firstDow; i++) cells += '<span></span>';
    for (let day = 1; day <= daysInMo; day++) {
      const t = day === d;
      cells += `<span style="${t ? 'background:var(--red);color:#fff;border-radius:50%;font-weight:700;' : 'color:#333;'}">${day}</span>`;
    }
    return `<div class="cat-special-box">
      <h3>📅 Lịch vạn niên</h3>
      <div style="display:flex;gap:12px;align-items:center;padding-bottom:10px;border-bottom:1px solid #eee;margin-bottom:10px;">
        <div style="font-size:2.6rem;font-weight:900;color:var(--red);line-height:1;min-width:48px;text-align:center;">${d}</div>
        <div>
          <div style="font-weight:700;font-size:.9rem;color:#222;">${DOW[now.getDay()]}</div>
          <div style="font-size:.8rem;color:#666;">${MON[mo]}, ${y}</div>
          <div style="font-size:.8rem;color:#b71c1c;margin-top:3px;">🌙 Ngày ${lunarDay} · Tháng Giêng · Bính Ngọ</div>
        </div>
      </div>
      <div style="font-size:.78rem;color:#444;display:grid;gap:5px;margin-bottom:10px;">
        <div style="display:flex;gap:6px;"><span style="color:#999;white-space:nowrap;">Can chi:</span><span style="font-weight:600;">Mậu Dần</span></div>
        <div style="display:flex;gap:6px;"><span style="color:#999;white-space:nowrap;">Tiết khí:</span><span style="font-weight:600;">Vũ Thủy</span></div>
        <div style="display:flex;gap:6px;"><span style="color:#999;white-space:nowrap;">Giờ hoàng đạo:</span><span style="font-weight:600;">Tý · Mão · Ngọ · Dậu</span></div>
      </div>
      <div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-size:.72rem;font-weight:700;color:#999;margin-bottom:4px;">
          <span>CN</span><span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span>
        </div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-size:.75rem;gap:2px 0;">${cells}</div>
      </div>
    </div>`;
  }

  function buildSpecialBox(sub) {
    const type = sub.special;
    if (type === 'war-map') return buildWarMapWidget();
    if (type === 'traffic-fine') return `<div class="cat-special-box">
      <h3>🚗 Tra cứu phạt nguội</h3>
      <div class="search-row">
        <input type="text" placeholder="Nhập biển số xe (VD: 30A-12345)">
        <button class="search-btn">Tra cứu</button>
      </div></div>`;
    let html = `<div class="cat-special-box">`;
    switch(type) {
      case 'stock-search':
        html += `<h3>Tra cứu mã chứng khoán</h3>
          <div class="search-row">
            <input type="text" placeholder="Nhập mã CK (VD: VIC, VNM, FPT...)">
            <button class="search-btn">Tìm kiếm</button>
          </div>`;
        break;
      case 'ebank-search':
        html += `<h3>Tra cứu lãi suất ngân hàng</h3>
          <div class="search-row">
            <select><option>Gửi tiền</option><option>Vay tiền</option></select>
            <select><option value="">Chọn ngân hàng</option>${D.BANKS.map(b => `<option>${b}</option>`).join('')}</select>
            <select><option value="">Kỳ hạn</option>${D.LOAN_TERMS.map(t => `<option>${t}</option>`).join('')}</select>
            <button class="search-btn">Tra cứu</button>
          </div>`;
        break;
      case 'project-search':
        html += `<h3>Tìm kiếm dự án bất động sản</h3>
          <div class="search-row">
            <input type="text" placeholder="Nhập tên dự án, khu vực...">
            <button class="search-btn">Tìm kiếm</button>
          </div>`;
        break;
      case 'disease-search':
        html += `<h3>Tra cứu thông tin bệnh</h3>
          <div class="search-row">
            <input type="text" placeholder="Nhập tên bệnh, triệu chứng...">
            <button class="search-btn">Tìm kiếm</button>
          </div>`;
        break;
      case 'law-search':
        html += `<h3>Thư viện văn bản pháp luật</h3>
          <div class="search-row">
            <input type="text" placeholder="Nhập số hiệu, tên văn bản...">
            <button class="search-btn">Tìm kiếm</button>
          </div>`;
        break;
      case 'exam-search':
        html += `<h3>Tra cứu đề thi & đáp án</h3>
          <div class="search-row">
            <input type="text" placeholder="Nhập từ khóa...">
            <select><option value="">Năm</option><option>2026</option><option>2025</option><option>2024</option><option>2023</option></select>
            <select><option value="">Cấp</option><option>Trường</option><option>Tỉnh</option><option>Quốc gia</option><option>Thế giới</option></select>
            <select><option value="">Môn học</option><option>Toán</option><option>Văn</option><option>Anh</option><option>Lý</option><option>Hóa</option><option>Sinh</option></select>
            <button class="search-btn">Tìm kiếm</button>
          </div>`;
        break;
      case 'destination-search':
        html += `<h3>Khám phá điểm đến du lịch</h3>
          <div class="search-row">
            <input type="text" placeholder="Nhập tên địa danh, thành phố...">
            <button class="search-btn">Tìm kiếm</button>
          </div>`;
        break;
      case 'thietbi-search':
        html += `<h3>Tìm kiếm sản phẩm công nghệ</h3>
          <div class="search-row">
            <input type="text" placeholder="Điện thoại, laptop, tivi, tủ lạnh...">
            <button class="search-btn">Tìm kiếm</button>
          </div>`;
        break;
      case 'quyhoach-search':
        html += `<h3>Tra cứu quy hoạch</h3>
          <div class="search-row">
            <input type="text" placeholder="Nhập tỉnh/thành phố...">
            <input type="text" placeholder="Quận/huyện...">
            <button class="search-btn">Tra cứu</button>
          </div>`;
        break;
    }
    html += `</div>`;
    return html;
  }

  // ============================================================
  // RENDER ARTICLE DETAIL
  // ============================================================
  function renderArticle(articleId) {
    $('#webCatSubsBar').style.display = 'none';
    const a = findArticleById(articleId);
    const cat = D.CATEGORIES.find(c => c.id === a.categoryId);
    const sub = cat ? cat.subs.find(s => s.id === a.subId) : null;
    const detail = $('#articleDetail');

    // breadcrumb
    let html = `<div class="article-breadcrumb fade-up">
      <a href="#category/${a.categoryId}">${a.categoryName || (cat ? cat.name : '')}</a>
      <span class="sep">›</span>
      <a href="#category/${a.categoryId}/${a.subId}">${a.subName || (sub ? sub.name : '')}</a>
    </div>`;

    // meta
    html += `<div class="article-meta fade-up">
      <span>${a.time}</span>
      <button class="audio-btn">&#128266; Nghe bài viết</button>
      <button class="summary-btn">✦ Tóm tắt</button>
      <div class="more-menu-wrap">
        <button class="more-btn" id="moreMenuBtn" title="Thêm tùy chọn">···</button>
        <div class="more-dropdown" id="moreDropdown">
          <button id="btnFontSize">Aa &nbsp;Điều chỉnh cỡ chữ</button>
          <button id="btnReport">&#9873; &nbsp;Báo cáo</button>
        </div>
      </div>
    </div>`;

    // title
    html += `<h1 class="article-title fade-up">${a.title}</h1>`;
    html += `<img class="article-hero-img fade-up" src="${a.avaUrl}" alt="" loading="lazy">`;

    // sapo
    html += `<p class="article-sapo fade-up">${a.sapo}</p>`;

    // body
    html += `<div class="article-body fade-up">${a.content}</div>`;

    // author + source
    html += `<div class="article-author fade-up">${a.author}</div>`;
    html += `<div class="article-source fade-up">${a.source}</div>`;

    // AI Questions — dùng câu hỏi riêng của bài thật nếu có
    const questions = (a.questions && a.questions.length === 4) ? a.questions : D.getRandomQuestions();
    html += `<div class="ai-questions fade-up">
      <h3>Giải mã đa tầng</h3>`;
    questions.forEach((q, i) => {
      html += `<div class="ai-q-card" data-idx="${i}">
        <button class="ai-q-trigger">
          <span>${q.q}</span>
          <span class="arrow">▼</span>
        </button>
        <div class="ai-q-answer"><p>${q.a}</p></div>
      </div>`;
    });
    html += `</div>`;

    // Utilities
    html += `<div class="utilities-section fade-up">
      <h3>Tiện ích liên quan</h3>
      <div class="utilities-grid">`;
    D.UTILITIES.forEach(u => {
      html += `<div class="utility-card">
        <span class="utility-icon">${u.icon}</span>
        <span>${u.name}</span>
      </div>`;
    });
    html += `</div></div>`;

    // Toàn cảnh
    const relatedArts = D.generateArticles(a.categoryId, 5);
    html += buildRelatedSection('Toàn cảnh', relatedArts);

    // Tin cùng chuyên mục
    const sameArts = D.generateArticles(a.categoryId, 5);
    html += buildRelatedSection('Tin cùng chuyên mục', sameArts);

    // Đọc nhiều nhất 48h
    html += `<div class="related-section fade-up">
      <div class="section-head"><span class="sec-title" style="cursor:default">Đọc nhiều nhất 48h</span></div>
      <div class="most-read-list">`;
    D.MOST_READ_48H.forEach(mr => {
      html += `<div class="most-read-item" data-id="${mr.id}"><span class="mr-title">${mr.title}</span></div>`;
    });
    html += `</div></div>`;

    detail.innerHTML = html;

    // Bind AI Q&A
    $$('.ai-q-card', detail).forEach(card => {
      const trigger = card.querySelector('.ai-q-trigger');
      trigger.addEventListener('click', () => {
        card.classList.toggle('open');
      });
    });

    // Bind 3-dot more menu
    const moreBtn = $('#moreMenuBtn');
    const moreDrop = $('#moreDropdown');
    if (moreBtn && moreDrop) {
      moreBtn.addEventListener('click', e => {
        e.stopPropagation();
        moreDrop.classList.toggle('show');
      });
      document.addEventListener('click', () => moreDrop.classList.remove('show'));
      moreDrop.addEventListener('click', e => e.stopPropagation());
    }

    // Bind most-read clicks
    $$('.most-read-item', detail).forEach(item => {
      item.addEventListener('click', () => {
        location.hash = `#article/${item.dataset.id}`;
      });
    });

    // Bind summary button in article detail
    const summaryBtn = detail.querySelector('.summary-btn');
    if (summaryBtn) {
      summaryBtn.addEventListener('click', e => { e.stopPropagation(); artShowSummary(e, a.sapo); });
    }

    // Bind related section rows — navigate only on title/img click
    $$('.related-list .article-row', detail).forEach(row => {
      const art = findArticleById(row.dataset.id);
      if (art) makeClickable(row, art);
    });

    // Show sticky bottom
    $('#stickyBottom').classList.add('visible');

    // Like toggle
    $('#btnLike').onclick = function() { this.classList.toggle('liked'); };

    window.scrollTo(0, 0);
  }

  function buildRelatedSection(title, articles) {
    let html = `<div class="related-section fade-up">
      <div class="section-head"><span class="sec-title" style="cursor:default">${title}</span></div>
      <div class="related-list">`;
    articles.forEach(a => {
      html += `<div class="article-row" data-id="${a.id}">
        ${articleRowHTML(a)}
      </div>`;
    });
    html += `</div>
      <button class="btn-more">Xem thêm ›</button>
    </div>`;
    return html;
  }

  // ============================================================
  // ROUTER
  // ============================================================
  function handleRoute() {
    const hash = location.hash || '#home';
    const parts = hash.replace('#', '').split('/');

    // Hide all pages
    $$('.page').forEach(p => p.classList.remove('active'));
    $('#stickyBottom').classList.remove('visible');
    $$('.nav-cat-link').forEach(l => l.classList.remove('active'));

    if (parts[0] === 'category' && parts[1]) {
      $('#page-category').classList.add('active');
      renderCategory(parts[1], parts[2] || null);
      window.scrollTo(0, 0);
    } else if (parts[0] === 'article' && parts[1]) {
      $('#page-article').classList.add('active');
      renderArticle(parts[1]);
    } else if (parts[0] === 'library') {
      $('#page-library').classList.add('active');
      renderLibrary();
      window.scrollTo(0, 0);
    } else {
      $('#page-home').classList.add('active');
      window.scrollTo(0, 0);
    }
  }

  // ============================================================
  // INIT
  // ============================================================
  buildTicker();
  buildNav();
  buildMenu();
  renderHome();
  handleRoute();

  window.addEventListener('hashchange', handleRoute);

  // ============================================================
  // ARTICLE QUICK ICONS — event delegation
  // ============================================================
  function artShowSummary(e, sapo) {
    const popup = $('#artSummaryPopup');
    $('#artSummaryText').textContent = sapo || 'Không có tóm tắt.';
    popup.classList.add('open');
    requestAnimationFrame(() => {
      const vw = window.innerWidth;
      const pw = popup.offsetWidth, ph = popup.offsetHeight;
      let left = e.clientX - pw + 20;
      let top = e.clientY - ph - 10;
      if (left < 8) left = 8;
      if (left + pw > vw - 8) left = vw - pw - 8;
      if (top < 8) top = e.clientY + 24;
      popup.style.left = left + 'px';
      popup.style.top = top + 'px';
    });
  }

  document.addEventListener('click', e => {
    if (e.target.id === 'artSummaryClose') { $('#artSummaryPopup').classList.remove('open'); return; }
    const aiBtn = e.target.closest('.art-ai-btn');
    if (aiBtn) {
      e.stopPropagation();
      artShowSummary(e, aiBtn.dataset.sapo);
      return;
    }
    const audioBtn = e.target.closest('.art-audio-btn');
    if (audioBtn) {
      e.stopPropagation();
      return;
    }
    if (!e.target.closest('#artSummaryPopup')) {
      $('#artSummaryPopup').classList.remove('open');
    }
  });
})();
</script>

<!-- PRESENT MODE PANEL -->
<div class="pm-panel" id="pmPanel"></div>

<!-- AI SUMMARY POPUP -->
<div class="art-summary-popup" id="artSummaryPopup">
  <div class="art-summary-header">
    <span class="art-summary-badge">✦ AI Tóm tắt</span>
    <button id="artSummaryClose">✕</button>
  </div>
  <div class="art-summary-text" id="artSummaryText"></div>
</div>

<script>
// ============================================================
// PRESENT MODE — web.html
// ============================================================
(function() {
  // Annotations per page key
  const ANNOTATIONS = {
    home: [
      {
        selector: 'nav.main-nav',
        point: 1,
        maxScroll: 200,
        title: 'Cấu trúc chuyên mục tinh gọn',
        desc: 'Cấu trúc mục đầy đủ các mảng mà một trang tin cần có & tinh gọn số mục — đảm bảo vẫn đủ chính trị, xã hội, pháp luật. Dễ tra cứu, ít rối.'
      },
      {
        selector: '.ticker-bar',
        point: 1,
        maxScroll: 400,
        title: 'Thông tin thời gian thực',
        desc: 'Cập nhật liên tục: thời tiết, giá vàng, chứng khoán — người đọc không cần rời trang để tra cứu.'
      },
      {
        selector: '#navLocal',
        point: 1,
        maxScroll: 200,
        title: 'Tin địa phương',
        desc: 'Lọc tin theo từng tỉnh thành: Hà Nội, TP.HCM, Đà Nẵng... Cá nhân hóa luồng tin theo địa lý — không bị cuốn vào tin không liên quan.'
      },
      {
        selector: '#navLatest',
        point: 1,
        maxScroll: 200,
        title: '"Mới nhất" — Tất cả tin theo thời gian',
        desc: 'Toàn bộ tin từ mọi chuyên mục, sắp xếp theo thời điểm đăng mới nhất — không bỏ sót bất kỳ tin nào vừa cập nhật.'
      },
      {
        selector: '#navQuantam',
        point: 1,
        maxScroll: 200,
        title: '"Quan tâm" — Cá nhân hóa nội dung',
        desc: 'Chọn chủ đề yêu thích, hệ thống tự lọc bài phù hợp — không còn lướt qua hàng chục tin không liên quan để tìm bài mình thích.'
      },
      {
        selector: '.top-cluster',
        point: 1,
        title: 'Khu vực tin nổi bật',
        desc: 'Giao diện tham khảo cấu trúc theo VNExpress nhưng đã tinh chỉnh để có sự khác biệt: bài lớn ưu tiên hình ảnh, phân cấp thông tin rõ ràng — độc giả nắm bắt tin quan trọng chỉ trong 3 giây.'
      },
      {
        selector: '.video-cluster-section',
        point: 1,
        title: 'Góc Video — Xem tin ngắn',
        desc: 'Tin tức dạng video ngắn cuộn dọc, phù hợp tiêu thụ nhanh khi di chuyển — không cần mở YouTube hay TikTok riêng.'
      },
      {
        selector: '[data-present="weather"]',
        point: 1,
        title: 'Thời tiết hôm nay',
        desc: 'Nhiệt độ và thời tiết 5 thành phố lớn ngay trong luồng tin — lên kế hoạch ngày mà không cần mở thêm app thời tiết riêng.'
      },
      {
        selector: '[data-present="match-schedule"]',
        point: 1,
        title: 'Lịch thi đấu bóng đá',
        desc: 'Lịch trực tiếp các trận đấu lớn cập nhật liên tục — fan bóng đá theo dõi ngay trong luồng đọc tin, không bỏ lỡ trận nào.'
      },
      {
        selector: '[data-present="exam-search"]',
        point: 1,
        title: 'Tra cứu đề thi & đáp án',
        desc: 'Đề thi và đáp án từ cấp trường đến quốc gia, theo từng môn và năm học — công cụ học tập cho học sinh và phụ huynh.'
      },
      {
        selector: '[data-present="tech-search"]',
        point: 1,
        title: 'Tìm kiếm sản phẩm công nghệ',
        desc: 'Tra cứu điện thoại, laptop, tivi, đồ gia dụng thông minh — so sánh thông số, giá cả để chọn sản phẩm phù hợp nhất.'
      },
      {
        selector: '[data-present="destination"]',
        point: 1,
        title: 'Khám phá điểm đến du lịch',
        desc: 'Tìm kiếm địa danh, thành phố trong và ngoài nước — gợi ý hành trình, điểm check-in, đặc sản địa phương ngay trên trang.'
      },
      {
        selector: '[data-present="traffic-fine"]',
        point: 1,
        title: 'Tra cứu phạt nguội',
        desc: 'Nhập biển số xe — xem kết quả vi phạm giao thông bị camera ghi nhận ngay trên trang, không cần truy cập trang Cục CSGT.'
      },
      {
        selector: '[data-present="stock-search"]',
        point: 1,
        title: 'Tra cứu mã chứng khoán',
        desc: 'Tìm giá, khối lượng giao dịch, biến động mã CK theo thời gian thực — độc giả đầu tư không cần rời trang để theo dõi danh mục.'
      },
      {
        selector: '[data-present="law-search"]',
        point: 1,
        title: 'Thư viện văn bản pháp luật',
        desc: 'Tra Nghị định, Thông tư, Luật... cập nhật đầy đủ và liên tục — tiện ích không thể thiếu với doanh nghiệp và người làm luật.'
      },
      {
        selector: '[data-present="disease-search"]',
        point: 1,
        title: 'Tra cứu thông tin bệnh',
        desc: 'Tìm hiểu triệu chứng, nguyên nhân, điều trị, phòng ngừa — giúp độc giả chủ động sức khỏe thay vì chỉ đọc tin y tế thụ động.'
      },
      {
        selector: '[data-present="project-search"]',
        point: 1,
        title: 'Tra cứu dự án bất động sản',
        desc: 'Kiểm tra pháp lý, tiến độ xây dựng, chủ đầu tư các dự án BĐS toàn quốc — hỗ trợ quyết định mua nhà và đầu tư có căn cứ.'
      },
      {
        selector: '[data-present="war-map"]',
        point: 1,
        title: 'Bản đồ chiến sự',
        desc: 'Trực quan hóa 3 xung đột lớn: Ukraine-Nga, Israel-Gaza, Mỹ-Iran — cập nhật theo diễn biến, giúp độc giả theo dõi tình hình toàn cầu.'
      },
      {
        selector: '[data-present="vn-map"]',
        point: 1,
        title: 'Bản đồ Tin nóng Việt Nam',
        desc: 'Chấm đỏ nhấp nháy đúng tỉnh thành xảy ra sự việc — nhấn vào để xem chuỗi tin tức nóng hổi tại địa điểm đó ngay lập tức.'
      },
      {
        selector: '#latestOverlay .latest-panel',
        point: 1,
        title: 'Panel "Mới nhất" — Cuộn nhanh không rời trang',
        desc: 'Toàn bộ tin mới nhất hiện trong panel nổi — đọc xong đóng lại, không mất vị trí đang đọc trên trang chính.'
      },
      {
        selector: '#localOverlay .local-panel',
        point: 1,
        title: 'Panel Địa phương — Chọn tỉnh thành tức thì',
        desc: 'Chọn tỉnh thành, luồng tin lọc ngay theo địa lý — không cần chuyển trang, không mất ngữ cảnh đang đọc.'
      },
      {
        selector: '#quantamOverlay .local-panel',
        point: 1,
        title: 'Panel "Quan tâm" — Feed cá nhân hóa',
        desc: 'Chọn chủ đề yêu thích một lần, hệ thống lọc tin vĩnh viễn theo sở thích — không còn lướt qua nội dung không liên quan.'
      }
    ],
    article: [
      {
        selector: '.article-meta',
        point: 1,
        title: 'Đọc hoặc Nghe',
        desc: 'Linh hoạt tiêu thụ nội dung theo nhu cầu — đọc khi yên tĩnh, nghe khi đang di chuyển.'
      },
      {
        selector: '.ai-questions',
        point: 1,
        title: '"Giải mã đa tầng"',
        desc: 'Bách khoa tri thức tích hợp — không chỉ biết tin, mà hiểu sâu bản chất vấn đề và ngữ cảnh xung quanh.'
      },
      {
        selector: '.utilities-section',
        point: 1,
        title: 'Tiện ích tra cứu liên quan',
        desc: 'Gợi ý công cụ tra cứu phù hợp với chủ đề bài đang đọc — tiếp cận thông tin chuyên sâu hơn ngay tại trang, không cần tìm kiếm riêng.'
      },
      {
        selector: '.related-section',
        point: 1,
        title: '"Toàn cảnh" — Đa chiều, đa nguồn',
        desc: 'Luồng thông tin từ nhiều nguồn, đa chiều về cùng sự kiện, có thêm bài viết góc nhìn chuyên sâu của các chuyên gia — người đọc tự đánh giá, không bị dẫn dắt một chiều.'
      }
    ],
    library: [
      {
        selector: '.lib-header',
        point: 2,
        title: '"Bách khoa tri thức"',
        desc: 'Kho tri thức cập nhật theo từng phút. Tự do tra cứu, đào sâu mọi vấn đề trong mọi lĩnh vực — không giới hạn chủ đề.'
      },
      {
        selector: '.lib-tabs-bar',
        point: 1,
        title: 'Ba chế độ tra cứu',
        desc: 'Chủ đề — Tra cứu — Hỏi AI: ba cách tiếp cận tri thức khác nhau, chuyển đổi chỉ một chạm theo nhu cầu của từng lúc.'
      },
      {
        selector: '#libBody [data-present="war-map"]',
        point: 1,
        title: 'Bản đồ chiến sự',
        desc: 'Trực quan hóa 3 xung đột lớn: Ukraine-Nga, Israel-Gaza, Mỹ-Iran — cập nhật theo diễn biến, giúp độc giả theo dõi tình hình toàn cầu.'
      },
      {
        selector: '#libBody [data-present="traffic-fine"]',
        point: 1,
        title: 'Tra cứu phạt nguội',
        desc: 'Nhập biển số xe — xem kết quả vi phạm giao thông bị camera ghi nhận ngay trên trang, không cần truy cập trang Cục CSGT.'
      },
      {
        selector: '#libBody [data-present="stock-search"]',
        point: 1,
        title: 'Tra cứu mã chứng khoán',
        desc: 'Tìm giá, khối lượng giao dịch, biến động mã CK theo thời gian thực — không cần rời trang để theo dõi danh mục đầu tư.'
      },
      {
        selector: '#libBody [data-present="ebank-search"]',
        point: 1,
        title: 'Tra cứu lãi suất ngân hàng',
        desc: 'So sánh lãi suất gửi tiết kiệm và vay vốn của hàng chục ngân hàng theo kỳ hạn — hỗ trợ quyết định tài chính cá nhân tốt hơn.'
      },
      {
        selector: '#libBody [data-present="project-search"]',
        point: 1,
        title: 'Tra cứu dự án bất động sản',
        desc: 'Kiểm tra pháp lý, tiến độ xây dựng, chủ đầu tư các dự án BĐS toàn quốc — hỗ trợ quyết định mua nhà và đầu tư có căn cứ.'
      },
      {
        selector: '#libBody [data-present="quyhoach-search"]',
        point: 1,
        title: 'Tra cứu quy hoạch',
        desc: 'Kiểm tra thông tin quy hoạch đất đai theo tỉnh thành, quận huyện — biết rõ khu đất định mua thuộc quy hoạch gì trước khi giao dịch.'
      },
      {
        selector: '#libBody [data-present="disease-search"]',
        point: 1,
        title: 'Tra cứu thông tin bệnh',
        desc: 'Tìm hiểu triệu chứng, nguyên nhân, điều trị, phòng ngừa — giúp độc giả chủ động sức khỏe thay vì chỉ đọc tin y tế thụ động.'
      },
      {
        selector: '#libBody [data-present="law-search"]',
        point: 1,
        title: 'Thư viện văn bản pháp luật',
        desc: 'Tra Nghị định, Thông tư, Luật... cập nhật đầy đủ và liên tục — tiện ích không thể thiếu với doanh nghiệp và người làm luật.'
      },
      {
        selector: '#libBody [data-present="exam-search"]',
        point: 1,
        title: 'Tra cứu đề thi & đáp án',
        desc: 'Đề thi và đáp án từ cấp trường đến quốc gia, theo từng môn và năm học — công cụ học tập cho học sinh, sinh viên và phụ huynh.'
      },
      {
        selector: '#libBody [data-present="destination"]',
        point: 1,
        title: 'Khám phá điểm đến du lịch',
        desc: 'Tìm kiếm địa danh, thành phố nổi tiếng trong và ngoài nước — gợi ý hành trình, điểm check-in, đặc sản địa phương ngay trên trang.'
      },
      {
        selector: '#libBody [data-present="tech-search"]',
        point: 1,
        title: 'Tìm kiếm sản phẩm công nghệ',
        desc: 'Tra cứu điện thoại, laptop, tivi, đồ gia dụng thông minh — so sánh thông số, giá cả, đánh giá để chọn sản phẩm phù hợp nhất.'
      }
    ],
    expert: [
      {
        selector: '#page-category .cat-stream',
        point: 3,
        title: '"Góc nhìn chuyên gia"',
        desc: 'Bài viết chuyên sâu từ chuyên gia hàng đầu: kinh tế, tài chính, sức khỏe, giáo dục — phân tích bền vững, không chỉ tin nhất thời.'
      }
    ],
    category: [
      {
        selector: '#catTopCluster [data-present="vn-map"]',
        point: 1,
        title: 'Bản đồ Tin nóng Việt Nam',
        desc: 'Chấm đỏ nhấp nháy đúng tỉnh thành xảy ra sự việc — nhấn vào để xem chuỗi tin tức nóng hổi tại địa điểm đó ngay lập tức.'
      },
      {
        selector: '#catTopCluster [data-present="war-map"], #catSpecial [data-present="war-map"]',
        point: 1,
        title: 'Bản đồ chiến sự',
        desc: 'Trực quan hóa 3 xung đột lớn: Ukraine-Nga, Israel-Gaza, Mỹ-Iran — cập nhật theo diễn biến, giúp độc giả theo dõi tình hình toàn cầu.'
      },
      {
        selector: '#catSpecial [data-present="traffic-fine"]',
        point: 1,
        title: 'Tra cứu phạt nguội',
        desc: 'Nhập biển số xe — xem kết quả vi phạm giao thông bị camera ghi nhận ngay trên trang, không cần truy cập trang Cục CSGT.'
      },
      {
        selector: '#catSpecial [data-present="stock-search"]',
        point: 1,
        title: 'Tra cứu mã chứng khoán',
        desc: 'Tìm giá, khối lượng giao dịch, biến động mã CK theo thời gian thực — không cần rời trang để theo dõi danh mục đầu tư.'
      },
      {
        selector: '#catSpecial [data-present="ebank-search"]',
        point: 1,
        title: 'Tra cứu lãi suất ngân hàng',
        desc: 'So sánh lãi suất gửi tiết kiệm và vay vốn của hàng chục ngân hàng theo kỳ hạn — hỗ trợ quyết định tài chính cá nhân.'
      },
      {
        selector: '#catSpecial [data-present="project-search"]',
        point: 1,
        title: 'Tra cứu dự án bất động sản',
        desc: 'Kiểm tra pháp lý, tiến độ xây dựng, chủ đầu tư các dự án BĐS toàn quốc — hỗ trợ quyết định mua nhà và đầu tư có căn cứ.'
      },
      {
        selector: '#catSpecial [data-present="quyhoach-search"]',
        point: 1,
        title: 'Tra cứu quy hoạch',
        desc: 'Kiểm tra thông tin quy hoạch đất đai theo tỉnh thành, quận huyện — biết rõ khu đất định mua thuộc quy hoạch gì trước khi giao dịch.'
      },
      {
        selector: '#catSpecial [data-present="disease-search"]',
        point: 1,
        title: 'Tra cứu thông tin bệnh',
        desc: 'Tìm hiểu triệu chứng, nguyên nhân, điều trị, phòng ngừa — giúp độc giả chủ động sức khỏe thay vì chỉ đọc tin y tế thụ động.'
      },
      {
        selector: '#catSpecial [data-present="law-search"]',
        point: 1,
        title: 'Thư viện văn bản pháp luật',
        desc: 'Tra Nghị định, Thông tư, Luật... cập nhật đầy đủ và liên tục — tiện ích không thể thiếu với doanh nghiệp và người làm luật.'
      },
      {
        selector: '#catSpecial [data-present="exam-search"]',
        point: 1,
        title: 'Tra cứu đề thi & đáp án',
        desc: 'Đề thi và đáp án từ cấp trường đến quốc gia, theo từng môn và năm học — công cụ học tập cho học sinh và phụ huynh.'
      },
      {
        selector: '#catSpecial [data-present="destination"]',
        point: 1,
        title: 'Khám phá điểm đến du lịch',
        desc: 'Tìm kiếm địa danh, thành phố trong và ngoài nước — gợi ý hành trình, điểm check-in, đặc sản địa phương ngay trên trang.'
      },
      {
        selector: '#catSpecial [data-present="tech-search"]',
        point: 1,
        title: 'Tìm kiếm sản phẩm công nghệ',
        desc: 'Tra cứu điện thoại, laptop, tivi, đồ gia dụng thông minh — so sánh thông số, giá cả để chọn sản phẩm phù hợp nhất.'
      }
    ]
  };

  // W8: Auto-tag special box elements with data-present attributes by h3 text
  function pmLabelElements() {
    document.querySelectorAll('.cat-special-box').forEach(box => {
      const text = ((box.querySelector('h3') || {}).textContent || '').toLowerCase();
      if (text.includes('phạt nguội'))       box.dataset.present = 'traffic-fine';
      else if (text.includes('chứng khoán')) box.dataset.present = 'stock-search';
      else if (text.includes('lãi suất'))    box.dataset.present = 'ebank-search';
      else if (text.includes('pháp luật'))   box.dataset.present = 'law-search';
      else if (text.includes('bệnh'))        box.dataset.present = 'disease-search';
      else if (text.includes('dự án'))       box.dataset.present = 'project-search';
      else if (text.includes('đề thi'))      box.dataset.present = 'exam-search';
      else if (text.includes('quy hoạch'))   box.dataset.present = 'quyhoach-search';
      else if (text.includes('điểm đến'))    box.dataset.present = 'destination';
      else if (text.includes('công nghệ'))   box.dataset.present = 'tech-search';
      else if (text.includes('chiến sự'))    box.dataset.present = 'war-map';
      else if (text.includes('thời tiết'))   box.dataset.present = 'weather';
      else if (text.includes('bản đồ việt nam')) box.dataset.present = 'vn-map';
    });
    // Tag war-map widget (uses .war-map-full, not .cat-special-box)
    document.querySelectorAll('.war-map-full').forEach(el => {
      el.dataset.present = 'war-map';
    });
    // Tag match-schedule box (uses .match-schedule-box, not .cat-special-box)
    document.querySelectorAll('.match-schedule-box').forEach(el => {
      el.dataset.present = 'match-schedule';
    });
  }

  let presentOn = false;
  let pmObserver = null;
  let pmScrollTimer = null;
  let pmVisibleMap = new Map();
  let pmLitEls = new Set();
  let pmDismissedEls = new Set();
  let pmPageKey = 'home';

  function pmGetPageKey() {
    const hash = location.hash || '#home';
    const parts = hash.replace('#','').split('/');
    if (parts[0] === 'library') return 'library';
    if (parts[0] === 'article') return 'article';
    if (parts[0] === 'category' && parts[1] === 'goc-nhin-chuyen-gia') return 'expert';
    if (parts[0] === 'category') return 'category';
    if (parts[0] === 'home' || parts[0] === '') return 'home';
    return null;
  }

  function pmGetItems(pageKey) {
    if (!pageKey || !ANNOTATIONS[pageKey]) return [];
    return ANNOTATIONS[pageKey].map(ann => {
      const el = document.querySelector(ann.selector);
      return el ? { el, ann } : null;
    }).filter(Boolean);
  }

  function pmClearObserver() {
    if (pmObserver) { pmObserver.disconnect(); pmObserver = null; }
    pmVisibleMap.clear();
  }

  function pmClearLit() {
    pmLitEls.forEach(el => el.classList.remove('present-lit'));
    pmLitEls.clear();
  }

  function pmInitObserver(pageKey) {
    pmClearObserver();
    const items = pmGetItems(pageKey);
    if (!items.length) return;
    pmObserver = new IntersectionObserver(entries => {
      entries.forEach(e => pmVisibleMap.set(e.target, e.intersectionRatio));
    }, { threshold: [0, 0.1, 0.25, 0.5, 0.75, 1.0] });
    items.forEach(({ el }) => {
      el.classList.add('present-annotated');
      pmObserver.observe(el);
    });
  }

  // Returns up to 3 visible items sorted by proximity to viewport center
  function pmFindVisible(pageKey) {
    const vh = window.innerHeight;
    const viewCenter = vh * 0.42;
    const scrollY = window.scrollY || window.pageYOffset;
    const candidates = [];
    pmGetItems(pageKey).forEach(({ el, ann }) => {
      const ratio = pmVisibleMap.get(el) || 0;
      if (ratio < 0.05) return;
      if (ann.maxScroll !== undefined && scrollY > ann.maxScroll) return;
      if (pmDismissedEls.has(el)) return;
      const rect = el.getBoundingClientRect();
      const elCenter = rect.top + rect.height / 2;
      const dist = Math.abs(elCenter - viewCenter);
      candidates.push({ el, ann, dist });
    });
    candidates.sort((a, b) => a.dist - b.dist);
    return candidates.slice(0, 3);
  }

  // Render all visible annotations as stacked cards in the right panel
  function pmRenderPanel(items) {
    const panel = document.getElementById('pmPanel');
    pmClearLit();
    panel.innerHTML = '';
    if (!items.length) return;
    items.forEach(item => {
      const card = document.createElement('div');
      card.className = 'pm-card';
      card.innerHTML =
        '<button class="pm-card-close" aria-label="Đóng">✕</button>' +
        '<div class="pm-card-title">' + item.ann.title + '</div>' +
        '<div class="pm-card-desc">' + item.ann.desc + '</div>';
      card.querySelector('.pm-card-close').addEventListener('click', () => {
        pmDismissedEls.add(item.el);
        item.el.classList.remove('present-lit');
        pmLitEls.delete(item.el);
        card.remove();
      });
      panel.appendChild(card);
      item.el.classList.add('present-lit');
      pmLitEls.add(item.el);
    });
  }

  function pmOnScrollStop() {
    if (!presentOn) return;
    pmRenderPanel(pmFindVisible(pmPageKey));
  }

  function pmHideAll() {
    document.getElementById('pmPanel').innerHTML = '';
    pmClearLit();
    pmDismissedEls.clear();
  }

  function togglePresent() {
    presentOn = !presentOn;
    const btn = document.getElementById('presentToggleBtn');
    btn.classList.toggle('pm-on', presentOn);
    if (presentOn) {
      pmLabelElements();
      pmPageKey = pmGetPageKey();
      pmInitObserver(pmPageKey);
      setTimeout(pmOnScrollStop, 350);
    } else {
      pmClearObserver();
      pmHideAll();
      document.querySelectorAll('.present-annotated').forEach(el => {
        el.classList.remove('present-annotated', 'present-lit');
      });
    }
  }
  window.togglePresent = togglePresent;

  // Allow external code (e.g. renderLibSearchTab) to re-init after dynamic content renders
  window.pmReinit = function() {
    if (!presentOn) return;
    pmLabelElements();
    pmInitObserver(pmGetPageKey());
    setTimeout(pmOnScrollStop, 300);
  };

  // Scroll listener (W5)
  window.addEventListener('scroll', () => {
    if (!presentOn) return;
    clearTimeout(pmScrollTimer);
    document.getElementById('pmPanel').innerHTML = '';
    pmClearLit();
    pmScrollTimer = setTimeout(pmOnScrollStop, 450);
  }, { passive: true });

  // Hook hashchange (W7) — re-init annotations when page changes
  window.addEventListener('hashchange', () => {
    if (!presentOn) return;
    pmHideAll();
    document.querySelectorAll('.present-annotated').forEach(el => {
      el.classList.remove('present-annotated', 'present-lit');
    });
    pmPageKey = pmGetPageKey();
    setTimeout(() => {
      pmLabelElements();
      pmInitObserver(pmPageKey);
      setTimeout(pmOnScrollStop, 500);
    }, 250);
  });
})();
</script>

</body>
</html>
